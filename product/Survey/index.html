<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Test Engine Pro - sings.ai</title>
    <!-- å¼•å…¥ Tailwind CSS è„šæœ¬ä»¥ä½¿ç”¨å…¶åŠŸèƒ½ç±» -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Chart.js ç”¨äºæ•°æ®å¯è§†åŒ– -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- å¼•å…¥ Marked.js ç”¨äºå°† Markdown è½¬æ¢ä¸º HTML -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- å¼•å…¥ html2pdf.js ç”¨äºå°†æŠ¥å‘Šå¯¼å‡ºä¸º PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- å¼•å…¥ pako.js ç”¨äºæ•°æ®å‹ç¼© -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <!-- å¼•å…¥ Inter å­—ä½“ä»¥è·å¾—æ›´å¥½çš„è§†è§‰æ•ˆæœ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <!-- å¼•å…¥ Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        window.firebase = {
            initializeApp,
            getAuth,
            signInWithCustomToken,
            signInAnonymously,
            onAuthStateChanged,
            getFirestore,
            doc,
            setDoc,
            getDoc,
            collection
        };
    </script>
    <style>
        /* å®šä¹‰å…¨å±€æ ·å¼ */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0D0D1B;
            color: #E0E0E0;
        }
        /* å®šä¹‰æ¸å˜æ–‡æœ¬æ ·å¼ */
        .gradient-text {
            background: linear-gradient(90deg, #8A2BE2, #4F46E5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
        }
        /* å®šä¹‰æ­¥éª¤å®¹å™¨æ ·å¼ï¼ŒåŒ…å«è¿‡æ¸¡æ•ˆæœ */
        .step-section {
            background-color: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 2.5rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2), 0 0 15px rgba(106, 77, 255, 0.1);
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }
        /* éšè—çš„æ­¥éª¤æ ·å¼ */
        .hidden-step {
            opacity: 0;
            transform: translateY(20px);
            display: none;
        }
        /* å¯è§çš„æ­¥éª¤æ ·å¼ */
        .visible-step {
            opacity: 1;
            transform: translateY(0);
            display: block;
        }
        /* ä¸»è¦æŒ‰é’®æ ·å¼ */
        .btn-primary {
            background: linear-gradient(90deg, #8A2BE2, #4F46E5);
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(106, 77, 255, 0.4);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 25px rgba(106, 77, 255, 0.7);
        }
        .btn-primary:disabled {
            background: #374151;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        /* æ¬¡è¦æŒ‰é’®æ ·å¼ */
        .btn-secondary {
            background-color: rgba(255, 255, 255, 0.1);
            color: #d1d5db;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: background-color 0.3s;
        }
        .btn-secondary:hover {
            background-color: rgba(255, 255, 255, 0.15);
        }
        /* åŠ è½½åŠ¨ç”»è¦†ç›–å±‚ */
        .loader-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(13, 13, 27, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 50;
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            transition: opacity 0.3s ease;
        }
        /* AI æ€è€ƒåŠ¨ç”» */
        .ai-thinking-animation {
            width: 80px; height: 80px; position: relative;
        }
        .ai-thinking-animation .dot {
            position: absolute; width: 10px; height: 10px; background: #fff; border-radius: 50%; animation: pulse 1.5s infinite ease-in-out;
        }
        .ai-thinking-animation .dot1 { top: 0; left: 35px; }
        .ai-thinking-animation .dot2 { top: 25px; left: 10px; animation-delay: -0.2s; }
        .ai-thinking-animation .dot3 { top: 25px; left: 60px; animation-delay: 0.2s; }
        .ai-thinking-animation .dot4 { top: 50px; left: 35px; animation-delay: -0.4s; }
        .ai-thinking-animation .dot5 { top: 15px; left: 35px; background: #8A2BE2; animation-delay: -0.6s; }
        @keyframes pulse {
            0%, 100% { transform: scale(0.5); opacity: 0.5; }
            50% { transform: scale(1.2); opacity: 1; }
        }
        .loader-text {
            margin-top: 20px; color: #e0e0e0; font-size: 1rem; letter-spacing: 1px;
        }
        /* è¡¨å•è¾“å…¥æ¡†æ ·å¼ */
        .form-input, textarea {
            width: 100%; padding: 0.75rem 1rem; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; background-color: rgba(255, 255, 255, 0.05); color: #e0e0e0; transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus, textarea:focus {
            outline: none; border-color: #8A2BE2; box-shadow: 0 0 0 2px rgba(138, 43, 226, 0.5);
        }
        /* ç”¨æˆ·å¡ç‰‡æ ·å¼ï¼ŒåŒ…å«æ‚¬åœæ•ˆæœ */
        .user-card {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        .user-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(138, 43, 226, 0.2), 0 4px 6px -4px rgba(138, 43, 226, 0.1);
        }
        /* ç»ç’ƒæ‹Ÿæ€æ•ˆæœ */
        .glass-morphism {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .modal {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex; justify-content: center; align-items: center;
            z-index: 100;
        }
        .modal-content {
            background-color: #1a1a2e; border: 1px solid #374151; padding: 2rem; border-radius: 1rem;
            max-width: 90%; max-height: 90%; overflow-y: auto;
        }
    </style>
</head>
<body class="antialiased">

    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <nav class="fixed top-0 left-0 right-0 z-50 p-4">
        <div class="container mx-auto glass-morphism rounded-xl p-2 px-4 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <a href="https://sings.ai/#" class="flex items-center text-gray-300 hover:text-white transition-colors">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    <span id="nav-back">è¿”å›ä¸»é¡µ</span>
                </a>
                <a href="https://sings.ai/#" class="text-xl font-bold text-white">sings.ai</a>
            </div>
            <!-- è¯­è¨€åˆ‡æ¢ä¸‹æ‹‰èœå• -->
            <div class="relative" id="lang-switcher-container">
                <button id="lang-switch-toggle" type="button" class="inline-flex items-center justify-center px-3 py-2 text-sm font-medium text-gray-300 hover:text-white transition-colors focus:outline-none">
                    <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 008.716-6.747M12 21a9.004 9.004 0 01-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 017.843 4.582M12 3a8.997 8.997 0 00-7.843 4.582m15.686 0A11.953 11.953 0 0112 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0121 12c0 .778-.099 1.533-.284 2.253m0 0A17.919 17.919 0 0112 16.5c-3.162 0-6.133-.815-8.716-2.247m0 0A9.015 9.015 0 013 12c0-1.605.42-3.113 1.157-4.418" />
                    </svg>
                    <span id="current-lang-text">ç®€ä½“ä¸­æ–‡</span>
                    <svg class="w-4 h-4 ml-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                    </svg>
                </button>
                <div id="lang-switch-menu" class="hidden absolute right-0 mt-2 w-32 origin-top-right bg-gray-800/90 backdrop-blur-sm divide-y divide-gray-700 rounded-md shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none">
                    <div class="py-1" role="none">
                        <a href="#" class="lang-option text-gray-300 hover:bg-gray-700 hover:text-white block px-4 py-2 text-sm" role="menuitem" data-lang="zh">ç®€ä½“ä¸­æ–‡</a>
                        <a href="#" class="lang-option text-gray-300 hover:bg-gray-700 hover:text-white block px-4 py-2 text-sm" role="menuitem" data-lang="en">English</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- åŠ è½½åŠ¨ç”»è¦†ç›–å±‚ -->
    <div id="loader-overlay" class="loader-overlay" style="display: none;">
        <div class="ai-thinking-animation">
            <div class="dot dot1"></div><div class="dot dot2"></div><div class="dot dot3"></div><div class="dot dot4"></div><div class="dot dot5"></div>
        </div>
        <div id="loader-text" class="loader-text">AI æ­£åœ¨æ€è€ƒ...</div>
    </div>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="container mx-auto max-w-5xl px-4 md:px-8 pb-4 md:pb-8 pt-32 md:pt-40">
        <!-- å¤´éƒ¨ -->
        <header class="text-center my-10">
            <h1 id="header-title" class="text-3xl md:text-5xl font-extrabold text-white">AI <span class="gradient-text">Test</span> Engine</h1>
            <p id="header-subtitle" class="mt-3 text-lg text-gray-400">ç”± <span class="gradient-text font-semibold">SiliconFlow</span> æ¨¡å‹é©±åŠ¨çš„å®šé‡ç ”ç©¶å·¥å…·</p>
        </header>

        <main>
            <!-- è¿›åº¦æ¡ -->
            <div class="grid grid-cols-5 gap-2 md:gap-4 mb-8 p-4 bg-gray-900/50 rounded-lg border border-gray-800">
                <div id="progress-step-1" class="text-center text-indigo-400 font-semibold">
                    <div class="w-8 h-8 mx-auto rounded-full bg-indigo-500 text-white flex items-center justify-center mb-1">1</div>
                    <p class="text-xs md:text-sm">è¾“å…¥éœ€æ±‚</p>
                </div>
                <div id="progress-step-2" class="text-center text-gray-500">
                    <div class="w-8 h-8 mx-auto rounded-full bg-gray-700 flex items-center justify-center mb-1">2</div>
                    <p class="text-xs md:text-sm">ç¡®è®¤ç›®æ ‡</p>
                </div>
                <div id="progress-step-3" class="text-center text-gray-500">
                    <div class="w-8 h-8 mx-auto rounded-full bg-gray-700 flex items-center justify-center mb-1">3</div>
                    <p class="text-xs md:text-sm">ç”¨æˆ·æ‹›å‹Ÿ</p>
                </div>
                <div id="progress-step-4" class="text-center text-gray-500">
                    <div class="w-8 h-8 mx-auto rounded-full bg-gray-700 flex items-center justify-center mb-1">4</div>
                    <p class="text-xs md:text-sm">æ•°æ®å¤„ç†</p>
                </div>
                <div id="progress-step-5" class="text-center text-gray-500">
                    <div class="w-8 h-8 mx-auto rounded-full bg-gray-700 flex items-center justify-center mb-1">5</div>
                    <p class="text-xs md:text-sm">ç”ŸæˆæŠ¥å‘Š</p>
                </div>
            </div>

            <!-- æ­¥éª¤ 1: è¾“å…¥ç ”ç©¶éœ€æ±‚ -->
            <section id="step-1" class="step-section visible-step">
                <h2 id="step1-title" class="text-2xl font-bold mb-4">ç¬¬ä¸€æ­¥ï¼šè¾“å…¥åˆæ­¥ç ”ç©¶éœ€æ±‚</h2>
                <p id="step1-desc" class="mb-4 text-gray-400">è¯·åœ¨æ­¤è¾“å…¥æ‚¨å®½æ³›çš„ç ”ç©¶æƒ³æ³•æˆ–é—®é¢˜ï¼ŒAI å°†åœ¨ä¸‹ä¸€æ­¥å¸®æ‚¨ä¼˜åŒ–ã€‚</p>
                <textarea id="research-goal-initial" class="h-40" placeholder="ä¾‹å¦‚ï¼šæˆ‘æƒ³äº†è§£ä¸€ä¸‹å¹´è½»äººå¯¹æ™ºèƒ½æ‰‹è¡¨çš„çœ‹æ³•ã€‚"></textarea>
                <button id="optimize-goal-btn" class="btn-primary mt-4 w-full font-bold py-3 px-4 rounded-md flex items-center justify-center disabled:opacity-50">
                    <span id="step1-button-text">âœ¨ ç”Ÿæˆä¼˜åŒ–å»ºè®®</span>
                    <div class="ai-thinking-animation w-6 h-6 ml-3 hidden"></div>
                </button>
            </section>

            <!-- æ­¥éª¤ 2: ç¡®è®¤ç ”ç©¶ç›®æ ‡ -->
            <section id="step-2" class="step-section hidden-step">
                <h2 id="step2-title" class="text-2xl font-bold mb-4">ç¬¬äºŒæ­¥ï¼šç¡®è®¤ç ”ç©¶ç›®æ ‡ä¸ç­–ç•¥</h2>
                <p id="step2-desc" class="mb-4 text-gray-400">è¿™æ˜¯ AI ä¸ºæ‚¨ä¼˜åŒ–çš„ç ”ç©¶ç›®æ ‡å’Œç­–ç•¥ã€‚æ‚¨å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œæˆ–æ ¹æ®éœ€è¦è¿›è¡Œä¿®æ”¹ã€‚</p>
                <h4 id="final-goal-title" class="text-xl font-bold mb-2 text-indigo-300">ç ”ç©¶ç›®æ ‡ï¼š</h4>
                <textarea id="research-goal-final" class="h-24"></textarea>
                <h4 id="strategies-title" class="text-xl font-bold mt-6 mb-2 text-indigo-300">å…³é”®ç ”ç©¶é—®é¢˜ä¸ç­–ç•¥ï¼š</h4>
                <div id="strategies-container" class="prose prose-invert max-w-none p-4 bg-gray-900/50 rounded-md"></div>
                <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4 mt-6">
                    <button id="edit-questionnaire-btn" class="btn-secondary w-full justify-center">ç¼–è¾‘é—®å·</button>
                    <button id="generate-questionnaire-btn" class="btn-primary w-full font-bold py-3 px-4 rounded-md flex items-center justify-center disabled:bg-gray-400">
                        <span id="step2-button-text">ç¡®è®¤ç­–ç•¥ï¼Œç”Ÿæˆé—®å·å¹¶æ‹›å‹Ÿç”¨æˆ·</span>
                        <div class="ai-thinking-animation w-6 h-6 ml-3 hidden"></div>
                    </button>
                </div>
            </section>

            <!-- æ­¥éª¤ 3: ç”¨æˆ·æ‹›å‹Ÿ -->
            <section id="step-3" class="step-section hidden-step">
                <h2 id="step3-title" class="text-2xl font-bold mb-4">ç¬¬ä¸‰æ­¥ï¼šç”¨æˆ·æ‹›å‹Ÿ</h2>
                <p id="step3-desc" class="mb-4 text-gray-400">å·²æ ¹æ®æ‚¨çš„ç ”ç©¶ç›®æ ‡æˆåŠŸæ‹›å‹Ÿä»¥ä¸‹è™šæ‹Ÿç”¨æˆ·ã€‚ä»–ä»¬å°†å‚ä¸åç»­çš„æ•°æ®é‡‡é›†ã€‚</p>
                <div id="recruited-users-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-96 overflow-y-auto"></div>
                <button id="proceed-to-data-collection-btn" class="btn-primary mt-6 w-full font-bold py-3 px-4 rounded-md flex items-center justify-center disabled:bg-gray-400 hidden">
                    <span id="step3-button-text">å¼€å§‹æ•°æ®é‡‡é›†</span>
                    <div class="ai-thinking-animation w-6 h-6 ml-3 hidden"></div>
                </button>
            </section>

            <!-- æ­¥éª¤ 4: æ•°æ®é‡‡é›† -->
            <section id="step-4" class="step-section hidden-step">
                <h2 id="step4-title" class="text-2xl font-bold mb-4">ç¬¬å››æ­¥ï¼šæ•°æ®é‡‡é›†</h2>
                <p id="step4-desc" class="mb-4 text-gray-400">AI æ­£åœ¨æ¨¡æ‹Ÿå·²æ‹›å‹Ÿçš„ç”¨æˆ·å¡«å†™é—®å·å¹¶å¤„ç†æ•°æ®ï¼Œè¯·ç¨å€™...</p>
                <div id="quantitative-progress-container" class="mt-8">
                    <h4 class="text-xl font-bold mb-2 text-indigo-300">å®šé‡æ•°æ®æ¨¡æ‹Ÿè¿›åº¦ï¼š</h4>
                    <div class="mt-4 text-center text-gray-400">
                        <p id="progress-text">æ­£åœ¨å¤„ç†æ•°æ®...</p>
                        <div class="w-full bg-gray-700 rounded-full h-4 mt-2">
                            <div id="progress-bar" class="bg-green-600 h-4 rounded-full text-xs font-medium text-blue-100 text-center p-0.5 leading-none" style="width: 0%; background: linear-gradient(90deg, #8A2BE2, #4F46E5);">0%</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- æ­¥éª¤ 5: ç”ŸæˆæŠ¥å‘Š -->
            <section id="step-5" class="step-section hidden-step">
                <h2 id="step5-title" class="text-2xl font-bold mb-4">ç¬¬äº”æ­¥ï¼šç”¨æˆ·ç ”ç©¶æŠ¥å‘Š</h2>
                <div id="report-content">
                    <div id="report-body">
                        <div class="mb-8 p-6 bg-gray-900/50 border-l-4 border-indigo-500 rounded-r-lg">
                            <h3 id="report-background-title" class="text-xl font-semibold text-indigo-300">ç ”ç©¶èƒŒæ™¯</h3>
                            <p id="report-goal" class="text-gray-300 mt-2"></p>
                        </div>
                        <div class="mb-8">
                            <h3 id="report-insights-title" class="text-xl font-semibold text-gray-200 mb-4">ç ”ç©¶æ•…äº‹ä¸æ ¸å¿ƒæ´å¯Ÿ</h3>
                            <div id="report-insights" class="prose prose-invert max-w-none p-4 bg-gray-900/50 rounded-md"></div>
                        </div>
                        <div>
                            <h3 id="report-charts-title" class="text-xl font-semibold text-gray-200 mb-4">æ•°æ®å¯è§†åŒ–å›¾è¡¨</h3>
                            <div id="report-charts" class="space-y-8"></div>
                        </div>
                    </div>
                </div>
                <div id="report-actions" class="mt-8">
                    <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
                        <button id="download-pdf-btn" class="btn-secondary w-full justify-center">ä¸‹è½½PDFæŠ¥å‘Š</button>
                        <button id="share-report-btn" class="btn-secondary w-full justify-center">åˆ†äº«æŠ¥å‘Š</button>
                    </div>
                    <div id="share-link-container" class="mt-4 hidden">
                        <label id="share-link-label" for="share-link-input" class="block text-sm font-medium text-gray-400">åˆ†äº«é“¾æ¥:</label>
                        <div class="mt-1 flex rounded-md shadow-sm">
                            <input type="text" id="share-link-input" class="form-input flex-1 block w-full rounded-none rounded-l-md" readonly>
                            <button id="copy-link-btn" class="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-600 bg-gray-700 text-gray-300 text-sm hover:bg-gray-600">å¤åˆ¶</button>
                        </div>
                    </div>
                </div>
                <button id="restart-btn" class="btn-primary mt-4 w-full justify-center">é‡æ–°å¼€å§‹</button>
            </section>
        </main>
    </div>

    <!-- é—®å·ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="questionnaire-modal" class="modal hidden">
        <div class="modal-content w-full max-w-2xl text-white">
            <h3 id="modal-title" class="text-2xl font-bold mb-4">ç¼–è¾‘é—®å·</h3>
            <div id="questionnaire-editor-container" class="space-y-6"></div>
            <div class="flex justify-end space-x-4 mt-6">
                <button id="save-questionnaire-btn" class="btn-primary">ä¿å­˜å¹¶è¿”å›</button>
                <button id="close-modal-btn" class="btn-secondary">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        // åº”ç”¨çŠ¶æ€ç®¡ç†
        const state = {
            currentStep: 1,
            researchGoal: '',
            researchStrategies: '',
            questionnaire: null,
            recruitedUsers: [],
            simulationResults: [],
            insightsHTML: '',
            currentLanguage: 'zh',
            db: null,
            auth: null,
            isAuthReady: false,
            appId: typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'
        };

        const config = {
            // åœ¨ Immersive ç¯å¢ƒä¸­ï¼ŒAPI Key ä¼šç”±ç³»ç»Ÿè‡ªåŠ¨æä¾›ï¼Œå› æ­¤æ­¤å¤„ç•™ç©º
            // å¦‚æœä½¿ç”¨ç¬¬ä¸‰æ–¹æœåŠ¡ï¼Œéœ€è¦æ‰‹åŠ¨åœ¨æ­¤å¤„é…ç½®å¯†é’¥ã€‚
            apiKey: 'sk-xifmrwnarxegowpdpwjmbpiodhjawjtacbkgtkoygpgszhec', // æ›¿æ¢ä¸ºä½ çš„ SiliconFlow å¯†é’¥
            // ä½¿ç”¨ alibaba/Qwen2-7B-Instruct æ¨¡å‹
            apiUrl: 'https://api.siliconflow.cn/v1/chat/completions',
            model: 'alibaba/Qwen2-7B-Instruct',
            simulationCount: 30, // æ¨¡æ‹Ÿç”¨æˆ·æ•°é‡
        };

        // --- I18N Translations (å›½é™…åŒ–) ---
        const translations = {
            zh: {
                nav_back: 'è¿”å›ä¸»é¡µ',
                current_lang_display: 'ç®€ä½“ä¸­æ–‡',
                header_title: 'AI <span class="gradient-text">Test</span> Engine',
                header_subtitle: 'ç”± <span class="gradient-text font-semibold">SiliconFlow</span> æ¨¡å‹é©±åŠ¨çš„å®šé‡ç ”ç©¶å·¥å…·',
                progress_step_1: 'è¾“å…¥éœ€æ±‚',
                progress_step_2: 'ç¡®è®¤ç›®æ ‡',
                progress_step_3: 'ç”¨æˆ·æ‹›å‹Ÿ',
                progress_step_4: 'æ•°æ®å¤„ç†',
                progress_step_5: 'ç”ŸæˆæŠ¥å‘Š',
                step1_title: 'ç¬¬ä¸€æ­¥ï¼šè¾“å…¥åˆæ­¥ç ”ç©¶éœ€æ±‚',
                step1_desc: 'è¯·åœ¨æ­¤è¾“å…¥æ‚¨å®½æ³›çš„ç ”ç©¶æƒ³æ³•æˆ–é—®é¢˜ï¼ŒAI å°†åœ¨ä¸‹ä¸€æ­¥å¸®æ‚¨ä¼˜åŒ–ã€‚',
                step1_placeholder: 'ä¾‹å¦‚ï¼šæˆ‘æƒ³äº†è§£ä¸€ä¸‹å¹´è½»äººå¯¹æ™ºèƒ½æ‰‹è¡¨çš„çœ‹æ³•ã€‚',
                step1_button_text: 'âœ¨ ç”Ÿæˆä¼˜åŒ–å»ºè®®',
                step2_title: 'ç¬¬äºŒæ­¥ï¼šç¡®è®¤ç ”ç©¶ç›®æ ‡ä¸ç­–ç•¥',
                step2_desc: 'è¿™æ˜¯ AI ä¸ºæ‚¨ä¼˜åŒ–çš„ç ”ç©¶ç›®æ ‡å’Œç­–ç•¥ã€‚æ‚¨å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œæˆ–æ ¹æ®éœ€è¦è¿›è¡Œä¿®æ”¹ã€‚',
                step2_final_goal_title: 'ç ”ç©¶ç›®æ ‡ï¼š',
                step2_strategies_title: 'å…³é”®ç ”ç©¶é—®é¢˜ä¸ç­–ç•¥ï¼š',
                step2_button_text: 'ç¡®è®¤ç­–ç•¥ï¼Œç”Ÿæˆé—®å·å¹¶æ‹›å‹Ÿç”¨æˆ·',
                step3_title: 'ç¬¬ä¸‰æ­¥ï¼šç”¨æˆ·æ‹›å‹Ÿ',
                step3_desc: 'å·²æ ¹æ®æ‚¨çš„ç ”ç©¶ç›®æ ‡æˆåŠŸæ‹›å‹Ÿä»¥ä¸‹è™šæ‹Ÿç”¨æˆ·ã€‚ä»–ä»¬å°†å‚ä¸åç»­çš„æ•°æ®é‡‡é›†ã€‚',
                step3_button_text: 'å¼€å§‹æ•°æ®é‡‡é›†',
                step4_title: 'ç¬¬å››æ­¥ï¼šæ•°æ®é‡‡é›†',
                step4_desc: 'AI æ­£åœ¨æ¨¡æ‹Ÿå·²æ‹›å‹Ÿçš„ç”¨æˆ·å¡«å†™é—®å·å¹¶å¤„ç†æ•°æ®ï¼Œè¯·ç¨å€™...',
                progress_text_processing: 'æ­£åœ¨å¤„ç†ç”¨æˆ·æ•°æ® {current}/{total}: {name}...',
                progress_text_done: 'æ•°æ®å¤„ç†å®Œæˆï¼å…±è·å¾— {count} ä»½æœ‰æ•ˆæ•°æ®ã€‚',
                step5_title: 'ç¬¬äº”æ­¥ï¼šç”¨æˆ·ç ”ç©¶æŠ¥å‘Š',
                report_background_title: 'ç ”ç©¶èƒŒæ™¯',
                report_insights_title: 'ç ”ç©¶æ•…äº‹ä¸æ ¸å¿ƒæ´å¯Ÿ',
                report_charts_title: 'æ•°æ®å¯è§†åŒ–å›¾è¡¨',
                download_pdf_btn: 'ä¸‹è½½PDFæŠ¥å‘Š',
                share_report_btn: 'åˆ†äº«æŠ¥å‘Š',
                share_link_label: 'åˆ†äº«é“¾æ¥:',
                copy_link_btn: 'å¤åˆ¶',
                copy_link_btn_copied: 'å·²å¤åˆ¶!',
                restart_btn: 'é‡æ–°å¼€å§‹',
                loader_thinking: 'AI æ­£åœ¨æ€è€ƒ...',
                loader_optimizing: 'æ­£åœ¨ä¼˜åŒ–ç ”ç©¶ç›®æ ‡...',
                loader_recruiting: 'æ­£åœ¨ç”Ÿæˆé—®å·å’Œæ‹›å‹Ÿç”¨æˆ·...',
                loader_simulating: 'æ­£åœ¨æ¨¡æ‹Ÿæ•°æ®é‡‡é›†...',
                loader_analyzing: 'æ­£åœ¨ç»¼åˆåˆ†ææ•°æ®å¹¶ç”Ÿæˆæ´å¯Ÿ...',
                loader_generating_pdf: 'æ­£åœ¨ç”ŸæˆPDFæŠ¥å‘Š...',
                loader_loading_report: 'æ­£åœ¨åŠ è½½åˆ†äº«çš„æŠ¥å‘Š...',
                modal_ok_btn: 'å¥½çš„',
                modal_no_initial_goal: 'è¯·å…ˆè¾“å…¥ä¸€ä¸ªåˆæ­¥çš„ç ”ç©¶ç›®æ ‡ã€‚',
                modal_goal_empty: 'ç ”ç©¶ç›®æ ‡ä¸èƒ½ä¸ºç©ºã€‚',
                modal_api_fail: 'AI è¯·æ±‚å¤±è´¥: {message}',
                modal_json_parse_error: 'AI è¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œæ— æ³•è§£æ: {message}',
                modal_process_fail: 'å¤„ç†å¤±è´¥: {message}',
                modal_insight_fail: 'æ— æ³•ç”Ÿæˆæ´å¯Ÿç»“è®º: {message}',
                modal_pdf_fail: 'ç”ŸæˆPDFæŠ¥å‘Šæ—¶å‡ºé”™ï¼Œè¯·é‡è¯•ã€‚',
                modal_bad_link: 'åˆ†äº«é“¾æ¥æ— æ•ˆæˆ–å·²æŸåã€‚',
                modal_edit_questionnaire: 'ç¼–è¾‘é—®å·',
                modal_edit_question_title: 'é—®é¢˜æ ‡é¢˜:',
                modal_edit_options_title: 'é€‰é¡¹ (æ¯è¡Œä¸€ä¸ª):',
                modal_edit_open_ended: 'è¿™æ˜¯ä¸€ä¸ªå¼€æ”¾å¼é—®é¢˜ï¼Œæ²¡æœ‰é€‰é¡¹ã€‚',
                modal_save_btn: 'ä¿å­˜',
                modal_cancel_btn: 'å–æ¶ˆ',
                user_card_age: 'å²',
                user_card_gender_male: 'ç”·',
                user_card_gender_female: 'å¥³',
                chat_you: 'ä½ ',
                chat_ai: 'AI',
                chart_label_percentage: 'é€‰æ‹©ç™¾åˆ†æ¯” (%)',
                chart_tooltip_people: 'äºº',
                pdf_filename: 'AIç”¨æˆ·ç ”ç©¶æŠ¥å‘Š-{title}.pdf',
                // æç¤ºè¯
                prompt_optimize: `ä½œä¸ºä¸€åé¡¶å°–çš„ç”¨æˆ·ç ”ç©¶ç­–ç•¥å¸ˆï¼Œè¯·å°†ä»¥ä¸‹è¿™ä¸ªè¾ƒä¸ºå®½æ³›çš„ç ”ç©¶æƒ³æ³•ï¼Œä¼˜åŒ–æˆä¸€ä¸ªæ›´ä¸“ä¸šã€æ›´èšç„¦ã€æ›´å…·å¯æ“ä½œæ€§çš„ç ”ç©¶ç›®æ ‡ã€‚è¯·ç›´æ¥è¿”å›ä¼˜åŒ–åçš„æ–‡æœ¬ï¼Œæ— éœ€ä»»ä½•é¢å¤–è§£é‡Šã€‚\n\nåŸå§‹æƒ³æ³•ï¼š\n"{goal}"`,
                prompt_strategies: `ä½œä¸ºä¸€åèµ„æ·±çš„ç”¨æˆ·ç ”ç©¶ç­–ç•¥å¸ˆï¼Œè¯·æ ¹æ®ä»¥ä¸‹ç ”ç©¶ç›®æ ‡ï¼Œæç‚¼å‡º 3 ä¸ªæœ€å…³é”®çš„ç ”ç©¶é—®é¢˜æˆ–å‡è®¾ï¼Œä»¥åŠç›¸åº”çš„ç ”ç©¶ç­–ç•¥ã€‚è¯·ç”¨ Markdown æ ¼å¼ç›´æ¥è¿”å›ï¼Œä¸è¦æœ‰é¢å¤–è§£é‡Šã€‚ä¾‹å¦‚ï¼š
### æ ¸å¿ƒç ”ç©¶é—®é¢˜
* é—®é¢˜ä¸€ï¼Ÿ
* é—®é¢˜äºŒï¼Ÿ
### ç ”ç©¶å‡è®¾
* å‡è®¾ä¸€
* å‡è®¾äºŒ
### ç ”ç©¶ç­–ç•¥
* ç­–ç•¥ä¸€
* ç­–ç•¥äºŒ

ç ”ç©¶ç›®æ ‡: "${state.researchGoal}"
`,
                prompt_questionnaire: `ä½œä¸ºä¸€åèµ„æ·±çš„ç”¨æˆ·ç ”ç©¶ä¸“å®¶ï¼Œè¯·æ ¹æ®ä»¥ä¸‹ç ”ç©¶ç›®çš„ï¼Œè®¾è®¡ä¸€ä»½ä¸“ä¸šçš„å®šé‡ç ”ç©¶é—®å·ã€‚\nç ”ç©¶ç›®çš„ï¼š"${state.researchGoal}"\n\nä½ çš„è¾“å‡ºå¿…é¡»æ˜¯ä¸€ä¸ªä¸¥æ ¼éµå¾ªä»¥ä¸‹JSONæ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œä¸è¦åŒ…å«ä»»ä½•é¢å¤–çš„è§£é‡Šæˆ–Markdownæ ‡è®°ï¼š\n\`\`\`json\n{\n  "title": "å…³äº...çš„ç ”ç©¶é—®å·",\n  "screener": [\n    { "questionId": "s1", "questionText": "æ‚¨åœ¨è¿‡å»ä¸€å¹´å†…æ˜¯å¦ä½¿ç”¨æˆ–è´­ä¹°è¿‡ç›¸å…³äº§å“/æœåŠ¡ï¼Ÿ", "questionType": "single-choice", "options": ["æ˜¯", "å¦"] }\n  ],\n  "mainBody": [\n    { "questionId": "m1", "questionText": "æ‚¨æœ€å¸¸ä½¿ç”¨çš„å“ç‰Œæ˜¯ä»€ä¹ˆï¼Ÿ", "questionType": "single-choice", "options": ["å“ç‰ŒA", "å“ç‰ŒB", "å“ç‰ŒC", "å…¶ä»–"] },\n    { "questionId": "m2", "questionText": "æ‚¨é€‰æ‹©è¯¥å“ç‰Œçš„ä¸»è¦åŸå› æ˜¯ä»€ä¹ˆï¼Ÿ(å¯å¤šé€‰)", "questionType": "multiple-choice", "options": ["ä»·æ ¼å®æƒ ", "æ€§èƒ½å¼ºå¤§", "è®¾è®¡ç¾è§‚", "æœ‹å‹æ¨è", "å¹¿å‘Šå½±å“"] }\n  ],\n  "demographics": [\n    { "questionId": "d1", "questionText": "æ‚¨çš„æ€§åˆ«æ˜¯ï¼Ÿ", "questionType": "single-choice", "options": ["ç”·", "å¥³", "å…¶ä»–"] },\n    { "questionId": "d2", "questionText": "æ‚¨çš„å¹´é¾„æ®µæ˜¯ï¼Ÿ", "questionType": "single-choice", "options": ["18å²ä»¥ä¸‹", "18-25å²", "26-35å²", "36-45å²", "45å²ä»¥ä¸Š"] },\n    { "questionId": "d3", "questionText": "æ‚¨çš„èŒä¸šæ˜¯ï¼Ÿ", "questionType": "single-choice", "options": ["å­¦ç”Ÿ", "æŠ€æœ¯/IT", "è®¾è®¡/è‰ºæœ¯", "æ•™è‚²/ç§‘ç ”", "åŒ»ç–—/å¥åº·", "è‡ªç”±èŒä¸š", "å…¶ä»–"] }\n  ]\n}\n\`\`\`\nè¯·ç¡®ä¿é—®é¢˜è®¾è®¡ä¸“ä¸šã€é€»è¾‘ä¸¥è°¨ï¼Œå¹¶å®Œæ•´è¦†ç›–ç”„åˆ«ã€ä¸»ä½“å’Œä¸ªäººä¿¡æ¯ä¸‰ä¸ªéƒ¨åˆ†ã€‚`,
                prompt_recruit: `ä½œä¸ºä¸€åä¸“ä¸šçš„å¸‚åœºç ”ç©¶æ‹›å‹Ÿä¸“å‘˜ï¼Œè¯·æ ¹æ®ä»¥ä¸‹ç ”ç©¶ç›®æ ‡ï¼Œä¸ºæˆ‘ç”Ÿæˆ ${config.simulationCount} ä½ç¬¦åˆæ¡ä»¶çš„è™šæ‹Ÿç”¨æˆ·ç”»åƒã€‚æ¯ä¸ªå¯¹è±¡éƒ½å¿…é¡»åŒ…å« "name" (ä¸€ä¸ªå¸¸è§çš„ä¸­æ–‡å), "age" (ä¸€ä¸ªæ•°å­—), "gender" (ç”·æˆ–å¥³), å’Œ "bio" (ä¸€æ®µ20-40å­—çš„ç”ŸåŠ¨è‡ªæˆ‘ä»‹ç»ï¼Œéœ€ç¬¦åˆå…¶ç”»åƒç‰¹å¾)ã€‚ä½ çš„è¾“å‡ºå¿…é¡»æ˜¯ä¸€ä¸ªä¸¥æ ¼çš„JSONæ•°ç»„ï¼Œæ•°ç»„ä¸­åŒ…å« ${config.simulationCount} ä¸ªå¯¹è±¡ï¼Œä¸è¦åŒ…å«ä»»ä½•é¢å¤–çš„è§£é‡Šæˆ–Markdownæ ‡è®°ã€‚\n\`\`\`json\n[\n  {\n    "name": "ææ˜",\n    "age": 28,\n    "gender": "ç”·",\n    "bio": "æˆ‘æ˜¯ä¸€ååœ¨åŒ—äº¬å·¥ä½œçš„è½¯ä»¶å·¥ç¨‹å¸ˆï¼Œå¹³æ—¶å–œæ¬¢ç ”ç©¶å„ç§æ•°ç äº§å“ï¼Œå¯¹æ–°æŠ€æœ¯å¾ˆæ•æ„Ÿï¼Œä¸šä½™æ—¶é—´ä¼šå»å¥èº«å’Œçˆ¬å±±ã€‚"\n  },\n  {\n    "name": "ç‹ç§€è‹±",\n    "age": 22,\n    "gender": "å¥³",\n    "bio": "æˆ‘æ˜¯ä¸Šæµ·ä¸€æ‰€å¤§å­¦çš„è®¾è®¡ç³»å­¦ç”Ÿï¼Œçƒ­çˆ±æ—¶å°šå’Œè‰ºæœ¯ï¼Œå–œæ¬¢ç”¨Vlogè®°å½•ç”Ÿæ´»ï¼Œå¯¹äº§å“çš„é¢œå€¼å’Œè®¾è®¡æ„Ÿæœ‰å¾ˆé«˜çš„è¦æ±‚ã€‚"\n  }\n]\n\`\`\`\nè¯·ç¡®ä¿ç”Ÿæˆçš„ç”¨æˆ·ç”»åƒå¤šæ ·åŒ–ï¼Œå¹¶èƒ½è¦†ç›–ç ”ç©¶ç›®æ ‡å¯èƒ½æ¶‰åŠçš„ä¸åŒç”¨æˆ·ç¾¤ä½“ã€‚`,
                prompt_simulate: `ä½ æ˜¯ä¸€ä¸ªé«˜çº§æ•°æ®æ¨¡æ‹Ÿå™¨ã€‚ç°åœ¨ï¼Œè¯·ä¸ºä»¥ä¸‹è¿™ä½å·²è¢«æ‹›å‹Ÿçš„ç”¨æˆ·ï¼Œå¡«å†™è¿™ä»½é—®å·ã€‚ \n\nä½ çš„ä»»åŠ¡æ˜¯ç”Ÿæˆä¸€ä¸ª JSON å¯¹è±¡ï¼Œä»£è¡¨è¿™ä½ç”¨æˆ·çš„å®Œæ•´é—®å·å›ç­”ã€‚å›ç­”å¿…é¡»ä¸¥æ ¼ç¬¦åˆç”¨æˆ·çš„ä¸ªäººç®€ä»‹(bio)å’Œç”»åƒç‰¹å¾ã€‚\n\nè¿™æ˜¯å½“å‰ç”¨æˆ·çš„ä¿¡æ¯ï¼š\n{user}\n\nè¿™æ˜¯éœ€è¦å¡«å†™çš„é—®å·ï¼š\n{questionnaire}\n\nä½ çš„è¾“å‡ºå¿…é¡»æ˜¯ä¸€ä¸ªä¸¥æ ¼çš„ã€æ ¼å¼å®Œå…¨æ­£ç¡®çš„ JSON å¯¹è±¡ã€‚ä¸è¦åŒ…å«ä»»ä½•é¢å¤–çš„è§£é‡Šæˆ– Markdown æ ‡è®°ï¼š\n\`\`\`json\n{\n    "respondentId": "user-1",\n    "persona": { "name": "ææ˜", "age": 28, "gender": "ç”·", "bio": "æˆ‘æ˜¯ä¸€ååœ¨åŒ—äº¬å·¥ä½œçš„è½¯ä»¶å·¥ç¨‹å¸ˆï¼Œå¹³æ—¶å–œæ¬¢ç ”ç©¶å„ç§æ•°ç äº§å“ï¼Œå¯¹æ–°æŠ€æœ¯å¾ˆæ•æ„Ÿï¼Œä¸šä½™æ—¶é—´ä¼šå»å¥èº«å’Œçˆ¬å±±ã€‚"},\n    "answers": [\n      { "questionId": "s1", "answer": "æ˜¯" },\n      { "questionId": "m1", "answer": "å“ç‰ŒA" },\n      { "questionId": "m2", "answer": ["æ€§èƒ½å¼ºå¤§"] },\n      { "questionId": "m3", "answer": "æ»¡æ„" },\n      { "questionId": "d1", "answer": "ç”·" },\n      { "questionId": "d2", "answer": "26-35å²" },\n      { "questionId": "d3", "answer": "æŠ€æœ¯/IT" }\n    ]\n}\n\`\`\`\nè¯·ç¡®ä¿å›ç­”ä¸ç”¨æˆ·çš„ä¸ªäººä¿¡æ¯å’Œç®€ä»‹é«˜åº¦ä¸€è‡´ã€‚`,
                prompt_analyze: `ä½œä¸ºä¸€åå–„äºè®²æ•…äº‹çš„é¡¶å°–ç”¨æˆ·ç ”ç©¶ä¸“å®¶ï¼Œè¯·å°†æœ¬æ¬¡ç ”ç©¶å‘ç°ç¼–ç»‡æˆä¸€ä¸ªå¼•äººå…¥èƒœçš„æ•…äº‹ã€‚ä½ çš„æŠ¥å‘Šä¸ä»…ä»…æ˜¯æ•°æ®ï¼Œè€Œæ˜¯å…³äºç”¨æˆ·ä½“éªŒçš„ç”ŸåŠ¨å™è¿°ã€‚

**ä½ çš„ä»»åŠ¡æ˜¯ï¼š**
å°†æ¯ç‡¥çš„æ•°æ®è½¬åŒ–ä¸ºä¸€ä¸ªç»“æ„æ¸…æ™°ã€é€»è¾‘ä¸¥è°¨ã€å……æ»¡æ´å¯ŸåŠ›çš„â€œç”¨æˆ·æ•…äº‹â€æŠ¥å‘Šã€‚

**æŠ¥å‘Šå¿…é¡»åŒ…å«ä»¥ä¸‹ç« èŠ‚ï¼Œå¹¶ä¸¥æ ¼éµå¾ªæ ¼å¼ï¼š**

### ğŸ“– æ•…äº‹å¼€ç¯‡ï¼šæ‰§è¡Œæ‘˜è¦
* ç”¨ä¸€ä¸¤å¥è¯ï¼Œé«˜åº¦æ¦‚æ‹¬æ•´ä¸ªæ•…äº‹çš„æ ¸å¿ƒï¼šæˆ‘ä»¬å‘ç°äº†ä»€ä¹ˆå…³é”®çš„ç”¨æˆ·è¡Œä¸ºæˆ–æ€åº¦ï¼Ÿ

### ğŸ¯ ç¬¬ä¸€ç« ï¼šæ ¸å¿ƒå‘ç° (The Key Findings)
* åˆ—å‡º 2-3 ä¸ªæœ€é‡è¦ã€æœ€æƒŠäººçš„å‘ç°ã€‚
* **æ¯ä¸€ä¸ªå‘ç°éƒ½å¿…é¡»ç”¨æ•°æ®è¯´è¯**ã€‚ä¾‹å¦‚ï¼šâ€œ**å‘ç°ä¸€ï¼š78% çš„ç”¨æˆ·åœ¨ä»·æ ¼é¡µé¢çŠ¹è±«ä¸å†³ã€‚**â€
* è¿™æ˜¯æ•…äº‹çš„ä¸»çº¿ï¼Œç›´æ¥å›åº”æˆ‘ä»¬çš„â€œç ”ç©¶ç›®æ ‡â€ã€‚

### ğŸ’¡ ç¬¬äºŒç« ï¼šæ·±å±‚æ´å¯Ÿ (The 'Aha!' Moment)
* é’ˆå¯¹æ¯ä¸€ä¸ªæ ¸å¿ƒå‘ç°ï¼Œæ·±å…¥æŒ–æ˜å…¶èƒŒåçš„ **â€œä¸ºä»€ä¹ˆâ€**ã€‚
* è¿™éƒ¨åˆ†æ˜¯æ•…äº‹çš„é«˜æ½®ã€‚è§£é‡Šç”¨æˆ·çš„åŠ¨æœºã€æƒ…æ„Ÿå’Œæ½œåœ¨éœ€æ±‚ã€‚
* ä¾‹å¦‚ï¼šâ€œç”¨æˆ·çŠ¹è±«ä¸å†³ï¼Œå¹¶éå› ä¸ºä»·æ ¼é«˜ï¼Œè€Œæ˜¯å› ä¸ºå¤æ‚çš„å®šä»·ç»“æ„è®©ä»–ä»¬æ„Ÿåˆ°å›°æƒ‘å’Œä¸ä¿¡ä»»ï¼ˆæ¨è®ºï¼‰ã€‚â€

### ğŸš€ ç¬¬ä¸‰ç« ï¼šæ•…äº‹æ–°ç¯‡ç«  (Actionable Recommendations)
* åŸºäºå‰é¢çš„æ´å¯Ÿï¼Œæå‡º **3ä¸ªå…·ä½“ã€å¯ç«‹å³æ‰§è¡Œçš„å»ºè®®**ã€‚
* æ¯ä¸ªå»ºè®®éƒ½åº”æ¸…æ™°åœ°è¯´æ˜â€œåšä»€ä¹ˆâ€ã€â€œä¸ºä»€ä¹ˆè¿™ä¹ˆåšâ€ã€‚
* ä¾‹å¦‚ï¼šâ€œ**1. ç®€åŒ–å®šä»·é¡µé¢ï¼š** å°†ä¸‰ä¸ªå¥—é¤åˆå¹¶ä¸ºä¸¤ä¸ªï¼Œå¹¶æä¾›ä¸€é”®å¯¹æ¯”åŠŸèƒ½ï¼Œä»¥å‡å°‘ç”¨æˆ·çš„è®¤çŸ¥è´Ÿè·ï¼Œé‡å»ºä¿¡ä»»æ„Ÿã€‚â€

---
**ç ”ç©¶é¡¹ç›®ä¿¡æ¯ï¼š**

**1. ç ”ç©¶é¡¹ç›®æ ‡é¢˜ï¼š**
"{title}"

**2. ç ”ç©¶ç›®æ ‡ï¼š**
{goal}

**3. å®šé‡æ•°æ®æ€»ç»“ï¼š**
{quantitativeSummary}
---

è¯·ç”¨ç®€æ´ã€æ˜“æ‡‚ã€å¼•äººå…¥èƒœçš„è¯­è¨€å¼€å§‹è®²è¿°è¿™ä¸ªå…³äºç”¨æˆ·çš„ç ”ç©¶æ•…äº‹ã€‚ç›´æ¥ä»¥ Markdown æ ¼å¼è¿”å›ä½ çš„æŠ¥å‘Šã€‚`
            },
            en: {
                nav_back: 'Back to Home',
                current_lang_display: 'English',
                header_title: 'AI <span class="gradient-text">Test</span> Engine',
                header_subtitle: 'Quantitative research tool powered by <span class="gradient-text font-semibold">SiliconFlow</span> models',
                progress_step_1: 'Input Demand',
                progress_step_2: 'Confirm Goal',
                progress_step_3: 'Recruit Users',
                progress_step_4: 'Data Collection',
                progress_step_5: 'Generate Report',
                step1_title: 'Step 1: Input Initial Research Demand',
                step1_desc: 'Please enter your broad research idea or question here. The AI will help you refine it in the next step.',
                step1_placeholder: 'e.g., I want to understand young people\'s opinions on smartwatches.',
                step1_button_text: 'âœ¨ Generate Refinement Suggestions',
                step2_title: 'Step 2: Confirm Research Goal & Strategy',
                step2_desc: 'This is the research goal and strategy refined by the AI. You can use it directly or modify it as needed.',
                step2_final_goal_title: 'Research Goal:',
                step2_strategies_title: 'Key Research Questions & Strategies:',
                step2_button_text: 'Confirm Strategy, Generate Questionnaire & Recruit Users',
                step3_title: 'Step 3: User Recruitment',
                step3_desc: 'The following virtual users have been successfully recruited based on your research goal. They will participate in the subsequent data collection.',
                step3_button_text: 'Proceed to Data Collection',
                step4_title: 'Step 4: Data Collection',
                step4_desc: 'The AI is simulating the recruited users filling out the questionnaire and processing the data. Please wait...',
                progress_text_processing: 'Processing user data {current}/{total}: {name}...',
                progress_text_done: 'Data processing complete! {count} valid responses obtained.',
                step5_title: 'Step 5: User Research Report',
                report_background_title: 'Research Background',
                report_insights_title: 'The Research Story & Core Insights',
                report_charts_title: 'Data Visualization Charts',
                download_pdf_btn: 'Download PDF Report',
                share_report_btn: 'Share Report',
                share_link_label: 'Share Link:',
                copy_link_btn: 'Copy',
                copy_link_btn_copied: 'Copied!',
                restart_btn: 'Start Over',
                loader_thinking: 'AI is thinking...',
                loader_optimizing: 'Refining research goal...',
                loader_recruiting: 'Generating questionnaire and recruiting users...',
                loader_simulating: 'Simulating data collection...',
                loader_analyzing: 'Synthesizing data and generating insights...',
                loader_generating_pdf: 'Generating PDF report...',
                loader_loading_report: 'Loading shared report...',
                modal_ok_btn: 'OK',
                modal_no_initial_goal: 'Please enter an initial research goal first.',
                modal_goal_empty: 'The research goal cannot be empty.',
                modal_api_fail: 'AI request failed: {message}',
                modal_json_parse_error: 'The data format returned by the AI is incorrect and cannot be parsed: {message}',
                modal_process_fail: 'Processing failed: {message}',
                modal_insight_fail: 'Failed to generate insights: {message}',
                modal_pdf_fail: 'An error occurred while generating the PDF report. Please try again.',
                modal_bad_link: 'The share link is invalid or corrupted.',
                modal_edit_questionnaire: 'Edit Questionnaire',
                modal_edit_question_title: 'Question Title:',
                modal_edit_options_title: 'Options (one per line):',
                modal_edit_open_ended: 'This is an open-ended question with no options.',
                modal_save_btn: 'Save',
                modal_cancel_btn: 'Cancel',
                user_card_age: 'years old',
                user_card_gender_male: 'Male',
                user_card_gender_female: 'Female',
                chart_label_percentage: 'Selection Percentage (%)',
                chart_tooltip_people: 'people',
                pdf_filename: 'AI-User-Research-Report-{title}.pdf',
                // æç¤ºè¯
                prompt_optimize: `As a top-tier user research strategist, please refine the following broad research idea into a more professional, focused, and actionable research goal. Return only the optimized text without any extra explanation.\n\nOriginal idea:\n"{goal}"`,
                prompt_strategies: `As a senior user research strategist, please distill 3 key research questions or hypotheses and corresponding strategies based on the following research objective. Return in Markdown format without any extra explanation. For example:
### Key Research Questions
* Question 1?
* Question 2?
### Research Hypotheses
* Hypothesis 1
* Hypothesis 2
### Research Strategies
* Strategy 1
* Strategy 2

Research Objective: "${state.researchGoal}"
`,
                prompt_questionnaire: `As a senior user research expert, please design a professional quantitative research questionnaire based on the following research objective.\nResearch Objective: "${state.researchGoal}"\n\nYour output must be a string in strict JSON format, without any extra explanations or Markdown tags:\n\`\`\`json\n{\n  "title": "Questionnaire on...",\n  "screener": [\n    { "questionId": "s1", "questionText": "Have you used or purchased related products/services in the past year?", "questionType": "single-choice", "options": ["Yes", "No"] }\n  ],\n  "mainBody": [\n    { "questionId": "m1", "questionText": "What brand do you use most often?", "questionType": "single-choice", "options": ["Brand A", "Brand B", "Brand C", "Other"] },\n    { "questionId": "m2", "questionText": "What are the main reasons for choosing this brand? (Multiple choice)", "questionType": "multiple-choice", "options": ["Affordable Price", "High Performance", "Aesthetic Design", "Friend's Recommendation", "Advertising Influence"] }\n  ],\n  "demographics": [\n    { "questionId": "d1", "questionText": "What is your gender?", "questionType": "single-choice", "options": ["Male", "Female", "Other"] },\n    { "questionId": "d2", "questionText": "What is your age range?", "questionType": "single-choice", "options": ["Under 18", "18-25", "26-35", "36-45", "Over 45"] },\n    { "questionId": "d3", "questionText": "What is your occupation?", "questionType": "single-choice", "options": ["Student", "Tech/IT", "Design/Art", "Education/Research", "Medical/Health", "Freelancer", "Other"] }\n  ]\n}\n\`\`\`\nEnsure the questions are professional, logical, and cover screening, main body, and demographic sections completely.`,
                prompt_recruit: `As a professional market research recruiter, please generate ${config.simulationCount} qualified virtual user personas based on the following research objective. Each object must include "name" (a common English name), "age" (a number), "gender" (Male or Female), and "bio" (a vivid 20-40 word self-introduction that matches their persona). Your output must be a strict JSON array of ${config.simulationCount} objects, without any extra explanations or Markdown tags.\n\`\`\`json\n[\n  {\n    "name": "John Smith",\n    "age": 28,\n    "gender": "Male",\n    "bio": "I'm a software engineer in New York, passionate about exploring new gadgets and technology. I enjoy hiking and going to the gym in my spare time."\n  },\n  {\n    "name": "Emily White",\n    "age": 22,\n    "gender": "Female",\n    "bio": "As a design student in Los Angeles, I love fashion and art. I vlog about my life and have high standards for product aesthetics and design."\n  }\n]\n\`\`\`\nEnsure the generated personas are diverse and cover different user groups relevant to the research objective.`,
                prompt_simulate: `You are an advanced data simulator. Your task is to fill out this questionnaire for the following recruited user. \n\nGenerate a JSON object representing the user's complete survey response. The answers must strictly align with the user's bio and persona.\n\nThis is the current user's information:\n{user}\n\nThis is the questionnaire to be filled out:\n{questionnaire}\n\nYour output must be a strictly and correctly formatted JSON object. Do not include any extra explanations or Markdown tags:\n\`\`\`json\n{\n    "respondentId": "user-1",\n    "persona": { "name": "John Smith", "age": 28, "gender": "Male", "bio": "I'm a software engineer in New York, passionate about exploring new gadgets and technology. I enjoy hiking and going to the gym in my spare time."},\n    "answers": [\n      { "questionId": "s1", "answer": "Yes" },\n      { "questionId": "m1", "answer": "Brand A" },\n      { "questionId": "m2", "answer": ["High Performance"] },\n      { "questionId": "m3", "answer": "Satisfied" },\n      { "questionId": "d1", "answer": "Male" },\n      { "questionId": "d2", "answer": "26-35" },\n      { "questionId": "d3", "answer": "Tech/IT" }\n    ]\n}\n\`\`\`\nEnsure the answers are highly consistent with the user's personal information and bio.`,
                prompt_analyze: `As a master storyteller and top-tier user research expert, weave the findings of this study into a compelling narrative. Your report is not just data; it's a vivid story about the user experience.

**Your Mission:**
Transform the raw data into a "User Story" report that is well-structured, logical, and full of insight.

**Report Structure (Must follow this format):**

### ğŸ“– The Story's Opening: Executive Summary
* In one or two sentences, summarize the core of the story: What key user behavior or attitude did we uncover?

### ğŸ¯ Chapter 1: The Key Findings
* List the 2-3 most important and surprising discoveries.
* **Every finding must be backed by data.** For example: "**Finding 1: 78% of users hesitated on the pricing page.**"
* This is the main plot of your story and must directly address our "Research Goal."

### ğŸ’¡ Chapter 2: The 'Aha!' Moment (The Insight)
* For each key finding, dig deep into the **"why"** behind it.
* This is the climax of the story. Explain the users' motivations, emotions, and underlying needs.
* For example: "Users hesitated not because the price was high, but because the complex pricing structure made them feel confused and distrustful (inference)."

### ğŸš€ Chapter 3: The Next Chapter (Actionable Recommendations)
* Based on the insights, provide **3 specific, immediately actionable recommendations.**
* Each recommendation should clearly state "what to do" and "why."
* For example: "**1. Simplify the Pricing Page:** Consolidate the three plans into two and add a one-click comparison feature to reduce cognitive load and rebuild trust."

---
**Research Project Information:**

**1. Project Title:**
"{title}"

**2. Research Goal:**
{goal}

**3. Quantitative Data Summary:**
{quantitativeSummary}
---

Now, begin telling this research story about our users in a language that is simple, clear, and engaging. Return your report directly in Markdown format.`
            }
        };

        const stepSections = Array.from({length: 5}, (_, i) => document.getElementById(`step-${i + 1}`));
        const optimizeGoalBtn = document.getElementById('optimize-goal-btn');
        const generateBtn = document.getElementById('generate-questionnaire-btn');
        const proceedToDataCollectionBtn = document.getElementById('proceed-to-data-collection-btn');
        const restartBtn = document.getElementById('restart-btn');
        const downloadPdfBtn = document.getElementById('download-pdf-btn');
        const shareReportBtn = document.getElementById('share-report-btn');
        const editQuestionnaireBtn = document.getElementById('edit-questionnaire-btn');
        const copyLinkBtn = document.getElementById('copy-link-btn');
        const researchGoalInitialInput = document.getElementById('research-goal-initial');
        const researchGoalFinalInput = document.getElementById('research-goal-final');
        const strategiesContainer = document.getElementById('strategies-container');
        const recruitedUsersContainer = document.getElementById('recruited-users-container');
        const quantitativeProgressContainer = document.getElementById('quantitative-progress-container');
        const progressText = document.getElementById('progress-text');
        const progressBar = document.getElementById('progress-bar');
        const reportGoal = document.getElementById('report-goal');
        const reportInsights = document.getElementById('report-insights');
        const reportCharts = document.getElementById('report-charts');
        const reportActions = document.getElementById('report-actions');
        const shareLinkContainer = document.getElementById('share-link-container');
        const shareLinkInput = document.getElementById('share-link-input');
        const loaderOverlay = document.getElementById('loader-overlay');
        const loaderText = document.getElementById('loader-text');
        const langSwitchContainer = document.getElementById('lang-switcher-container');
        const langSwitchToggle = document.getElementById('lang-switch-toggle');
        const langSwitchMenu = document.getElementById('lang-switch-menu');
        const currentLangText = document.getElementById('current-lang-text');
        const questionnaireModal = document.getElementById('questionnaire-modal');
        const questionnaireEditorContainer = document.getElementById('questionnaire-editor-container');
        const saveQuestionnaireBtn = document.getElementById('save-questionnaire-btn');
        const closeModalBtn = document.getElementById('close-modal-btn');
        let chartInstances = []; // ç”¨äºä¿å­˜ Chart.js å®ä¾‹

        const originalChartColor = Chart.defaults.color;
        let db, auth;

        // è·å–ç¿»è¯‘æ–‡æœ¬çš„è¾…åŠ©å‡½æ•°
        function T(key, replacements = {}) {
            let text = translations[state.currentLanguage][key] || key;
            for (const placeholder in replacements) {
                text = text.replace(new RegExp(`{${placeholder}}`, 'g'), replacements[placeholder]);
            }
            return text;
        }

        // åˆ‡æ¢è¯­è¨€å¹¶æ›´æ–°æ‰€æœ‰ UI æ–‡æœ¬
        function switchLanguage(lang) {
            state.currentLanguage = lang;
            document.documentElement.lang = lang;

            document.title = 'AI Test Engine - sings.ai';
            document.getElementById('nav-back').textContent = T('nav_back');
            currentLangText.textContent = T('current_lang_display');
            document.getElementById('header-title').innerHTML = T('header_title');
            document.getElementById('header-subtitle').innerHTML = T('header_subtitle');

            for (let i = 1; i <= 5; i++) {
                document.querySelector(`#progress-step-${i} p`).textContent = T(`progress_step_${i}`);
                const stepTitle = document.getElementById(`step${i}-title`);
                if (stepTitle) stepTitle.textContent = T(`step${i}_title`);
                const stepDesc = document.getElementById(`step${i}-desc`);
                if (stepDesc) stepDesc.textContent = T(`step${i}_desc`);
            }
            
            researchGoalInitialInput.placeholder = T('step1_placeholder');
            document.getElementById('step1-button-text').textContent = T('step1_button_text');
            document.getElementById('step2-button-text').textContent = T('step2_button_text');
            document.getElementById('step3-button-text').textContent = T('step3_button_text');
            
            if (state.researchStrategies) {
                strategiesContainer.innerHTML = marked.parse(state.researchStrategies);
            }
            
            document.getElementById('report-background-title').textContent = T('report_background_title');
            document.getElementById('report-insights-title').textContent = T('report_insights_title');
            document.getElementById('report-charts-title').textContent = T('report_charts_title');
            downloadPdfBtn.textContent = T('download_pdf_btn');
            shareReportBtn.textContent = T('share_report_btn');
            document.getElementById('share-link-label').textContent = T('share_link_label');
            copyLinkBtn.textContent = T('copy_link_btn');
            restartBtn.textContent = T('restart_btn');
            
            // å¦‚æœæŠ¥å‘Šå·²ç”Ÿæˆï¼Œé‡æ–°æ¸²æŸ“ä»¥åº”ç”¨æ–°è¯­è¨€
            if (state.currentStep === 5 && state.simulationResults.length > 0) {
                renderReportFromState();
            }
        }

        // æ›´æ–°è¿›åº¦æ¡çš„è§†è§‰çŠ¶æ€
        function updateProgressIndicator(step) {
            const progressSteps = document.querySelectorAll('[id^="progress-step-"]');
            progressSteps.forEach((s, index) => {
                const circle = s.querySelector('div');
                if (index + 1 <= step) {
                    s.classList.remove('text-gray-500');
                    s.classList.add('text-indigo-400', 'font-semibold');
                    circle.classList.remove('bg-gray-700');
                    circle.classList.add('bg-indigo-500', 'text-white');
                } else {
                    s.classList.remove('text-indigo-400', 'font-semibold');
                    s.classList.add('text-gray-500');
                    circle.classList.remove('bg-indigo-500', 'text-white');
                    circle.classList.add('bg-gray-700');
                }
            });
        }

        // åˆ‡æ¢æ˜¾ç¤ºæ­¥éª¤
        function switchStep(stepToShow) {
            state.currentStep = stepToShow;
            stepSections.forEach((section, index) => {
                section.classList.toggle('visible-step', index + 1 === stepToShow);
                section.classList.toggle('hidden-step', index + 1 !== stepToShow);
            });
            updateProgressIndicator(stepToShow);
        }

        // åˆ‡æ¢æŒ‰é’®çš„åŠ è½½çŠ¶æ€
        function setButtonLoading(button, isLoading) {
            const textSpan = button.querySelector('span');
            const loader = button.querySelector('.ai-thinking-animation');
            button.disabled = isLoading;
            if (textSpan) textSpan.style.display = isLoading ? 'none' : 'inline-block';
            if (loader) loader.style.display = isLoading ? 'block' : 'none';
        }
        
        // æ˜¾ç¤º/éšè—åŠ è½½åŠ¨ç”»
        function showLoader(show, textKey = 'loader_thinking') {
            loaderText.textContent = T(textKey);
            loaderOverlay.style.display = show ? 'flex' : 'none';
        }

        // æ˜¾ç¤ºè‡ªå®šä¹‰æ¨¡æ€æ¡†
        function showModal(messageKey, replacements = {}) {
            const message = T(messageKey, replacements);
            let existingModal = document.getElementById('custom-modal');
            if (existingModal) existingModal.remove();
            
            const modalOverlay = document.createElement('div');
            modalOverlay.id = 'custom-modal';
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4';
            
            const modalContent = document.createElement('div');
            modalContent.className = 'bg-gray-900 border border-gray-700 text-white p-6 rounded-lg shadow-lg max-w-sm mx-auto text-center';
            modalContent.onclick = (e) => e.stopPropagation();
            
            const messageP = document.createElement('p');
            messageP.textContent = message;
            messageP.className = 'mb-6 text-lg';
            
            const closeButton = document.createElement('button');
            closeButton.textContent = T('modal_ok_btn');
            closeButton.className = 'btn-primary w-full';
            
            modalOverlay.appendChild(modalContent);
            modalContent.append(messageP, closeButton);
            document.body.appendChild(modalOverlay);

            const closeModal = () => modalOverlay.remove();
            modalOverlay.addEventListener('click', closeModal);
            closeButton.addEventListener('click', closeModal);
        }

        // --- æ ¸å¿ƒé€»è¾‘å‡½æ•° ---

        /**
         * å°è£…çš„ AI API è°ƒç”¨å‡½æ•°ï¼Œæ”¯æŒé‡è¯•å’Œç»“æ„åŒ– JSON å“åº”ã€‚
         * @param {string} prompt - ä¼ é€’ç»™ AI çš„æ–‡æœ¬æç¤ºã€‚
         * @param {object} [options] - å¯é€‰å‚æ•°ã€‚
         * @param {boolean} [options.isJson] - æ˜¯å¦é¢„æœŸè¿”å› JSON æ ¼å¼æ•°æ®ã€‚
         * @returns {Promise<string|object>} - è¿”å›æ–‡æœ¬æˆ–è§£æåçš„ JSON å¯¹è±¡ã€‚
         */
        async function callAI(prompt, options = {}, retries = 3) {
            const { apiKey, apiUrl, model } = config;

            let payload = {
                model: model,
                messages: [{ role: 'user', content: prompt }],
                max_tokens: 4096
            };
            
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`API Error: ${response.status} ${errorText}`);
                        throw new Error(`API Error: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.choices && result.choices.length > 0) {
                        let content = result.choices[0].message.content.trim();
                        // å¦‚æœé¢„æœŸè¿”å› JSONï¼Œåˆ™è¿›è¡Œè§£æ
                        if (options.isJson) {
                            // å°è¯•å»é™¤ Markdown ä»£ç å—æ ‡è®°ï¼Œç„¶åè§£æ JSON
                            try {
                                if (content.startsWith("```json")) {
                                    content = content.substring(7, content.lastIndexOf("```")).trim();
                                }
                                return JSON.parse(content);
                            } catch (e) {
                                throw new Error(`JSON parsing failed: ${e.message}`);
                            }
                        }
                        return content;
                    } else {
                        throw new Error('API returned no valid content.');
                    }
                } catch (error) {
                    console.error(`Attempt ${i + 1} failed:`, error);
                    if (i === retries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, i)));
                }
            }
        }

        // ä¼˜åŒ–ç ”ç©¶ç›®æ ‡å¹¶ç”Ÿæˆç­–ç•¥
        async function handleOptimizeGoal() {
            const currentGoal = researchGoalInitialInput.value.trim();
            if (!currentGoal) return showModal('modal_no_initial_goal');
            
            setButtonLoading(optimizeGoalBtn, true);
            showLoader(true, 'loader_optimizing');
            
            try {
                const [optimizedGoal, strategies] = await Promise.all([
                    callAI(T('prompt_optimize', { goal: currentGoal })),
                    callAI(T('prompt_strategies', { goal: currentGoal }))
                ]);

                researchGoalFinalInput.value = optimizedGoal;
                state.researchGoal = optimizedGoal;
                state.researchStrategies = strategies;
                strategiesContainer.innerHTML = marked.parse(strategies);
                
                switchStep(2);
            } catch (error) {
                showModal('modal_api_fail', { message: error.message });
            } finally {
                setButtonLoading(optimizeGoalBtn, false);
                showLoader(false);
            }
        }

        // ç”Ÿæˆé—®å·å’Œæ‹›å‹Ÿç”¨æˆ·
        async function handleGenerateAndRecruit() {
            state.researchGoal = researchGoalFinalInput.value.trim();
            if (!state.researchGoal) return showModal('modal_goal_empty');
            
            setButtonLoading(generateBtn, true);
            showLoader(true, 'loader_recruiting');

            try {
                const [questionnaire, recruitedUsers] = await Promise.all([
                    callAI(T('prompt_questionnaire'), { isJson: true }),
                    callAI(T('prompt_recruit'), { isJson: true })
                ]);
                
                state.questionnaire = questionnaire;
                state.recruitedUsers = recruitedUsers;

                displayRecruitedUsers();
                proceedToDataCollectionBtn.classList.remove('hidden');
                switchStep(3);
            } catch (error) {
                const isJsonError = error.message.includes('JSON');
                const messageKey = isJsonError ? 'modal_json_parse_error' : 'modal_api_fail';
                showModal(messageKey, { message: error.message });
                console.error('Error in handleGenerateAndRecruit:', error);
                switchStep(2); 
            } finally {
                setButtonLoading(generateBtn, false);
                showLoader(false);
            }
        }

        // è°ƒç”¨ AI ç”Ÿæˆé—®å·
        function generateQuestionnaire() {
            const prompt = T('prompt_questionnaire');
            return callAI(prompt, { isJson: true });
        }

        // è°ƒç”¨ AI æ‹›å‹Ÿç”¨æˆ·
        function recruitUsers() {
            const prompt = T('prompt_recruit');
            return callAI(prompt, { isJson: true });
        }

        // åœ¨ UI ä¸­æ˜¾ç¤ºæ‹›å‹Ÿçš„ç”¨æˆ·
        function displayRecruitedUsers() {
            recruitedUsersContainer.innerHTML = '';
            state.recruitedUsers.forEach((user, index) => {
                const card = document.createElement('div');
                card.className = 'user-card bg-gray-900/50 p-4 rounded-lg border border-gray-700 flex items-center space-x-4';
                
                // --- MODIFICATION START ---
                // Use DiceBear for avatar generation
                const avatarUrl = `https://api.dicebear.com/8.x/lorelei/svg?seed=${encodeURIComponent(user.name)}`;
                // --- MODIFICATION END ---
                
                const genderText = (user.gender === 'Male' || user.gender === 'ç”·') ? T('user_card_gender_male') : T('user_card_gender_female');
                card.innerHTML = `<img src="${avatarUrl}" alt="User Avatar" class="w-16 h-16 rounded-full border-2 border-gray-600 bg-gray-700"><div class="flex-1"><h4 class="font-bold text-lg text-indigo-400">${user.name}</h4><p class="text-sm text-gray-400 mb-2">${genderText}, ${user.age}${T('user_card_age')}</p><p class="text-sm text-gray-300">${user.bio}</p></div>`;
                recruitedUsersContainer.appendChild(card);
                setTimeout(() => {
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, 100 * index);
            });
        }

        // æ¨¡æ‹Ÿç”¨æˆ·å¡«å†™é—®å·
        async function handleStartDataCollection() {
            switchStep(4);
            state.simulationResults = [];
            for (let i = 0; i < state.recruitedUsers.length; i++) {
                const user = state.recruitedUsers[i];
                progressText.textContent = T('progress_text_processing', { current: i + 1, total: state.recruitedUsers.length, name: user.name });
                
                const userString = JSON.stringify(user, null, 2);
                const questionnaireString = JSON.stringify(state.questionnaire, null, 2);
                
                const prompt = T('prompt_simulate', {
                    user: userString,
                    questionnaire: questionnaireString,
                });

                try {
                    const responseJson = await callAI(prompt, { isJson: true });
                    state.simulationResults.push(responseJson);
                    const progress = ((i + 1) / state.recruitedUsers.length) * 100;
                    progressBar.style.width = `${progress}%`;
                    progressBar.textContent = `${Math.round(progress)}%`;
                } catch (error) {
                    console.error(`Failed to simulate user ${user.name}:`, error);
                    continue;
                }
            }
            progressText.textContent = T('progress_text_done', { count: state.simulationResults.length });
            setTimeout(() => {
                switchStep(5);
                handleGenerateReport();
            }, 1000);
        }

        // ç”ŸæˆæŠ¥å‘Šå’Œå…³é”®æ´å¯Ÿ
        async function handleGenerateReport() {
            showLoader(true, 'loader_analyzing');
            
            const quantitativeSummary = state.simulationResults.length > 0 ? summarizeDataForAI() : "æ— å®šé‡æ•°æ®ã€‚";
                    
            const prompt = T('prompt_analyze', {
                title: state.questionnaire ? state.questionnaire.title : state.researchGoal,
                goal: state.researchGoal,
                quantitativeSummary: quantitativeSummary,
            });

            try {
                const insights = await callAI(prompt);
                state.insightsHTML = marked.parse(insights);
                renderReportFromState();
            } catch (error) {
                showModal('modal_insight_fail', { message: error.message });
            } finally {
                showLoader(false);
            }
        }

        // å°†æ•°æ®æ±‡æ€»ä¸º AI å¯è¯»çš„æ–‡æœ¬æ‘˜è¦
        function summarizeDataForAI() {
            let summary = `Total Samples: ${state.simulationResults.length}\n\n`;
            const allQuestions = [...(state.questionnaire.screener || []), ...(state.questionnaire.mainBody || []), ...(state.questionnaire.demographics || [])];
            allQuestions.forEach(q => {
                summary += `Question: "${q.questionText}"\n`;
                const counts = {};
                state.simulationResults.forEach(res => {
                    const answerObj = res.answers.find(a => a.questionId === q.questionId);
                    if (!answerObj || !answerObj.answer) return;
                    if (Array.isArray(answerObj.answer)) {
                        answerObj.answer.forEach(opt => { counts[opt] = (counts[opt] || 0) + 1; });
                    } else {
                        counts[answerObj.answer] = (counts[answerObj.answer] || 0) + 1;
                    }
                });
                for (const [option, count] of Object.entries(counts)) {
                    summary += `- ${option}: ${count} votes (${((count / state.simulationResults.length) * 100).toFixed(1)}%)\n`;
                }
                summary += "\n";
            });
            return summary;
        }

        // æ¸²æŸ“æŠ¥å‘Šå†…å®¹ï¼ˆåŒ…æ‹¬æ´å¯Ÿå’Œå›¾è¡¨ï¼‰
        function renderReportFromState() {
            reportGoal.textContent = state.researchGoal;
            reportInsights.innerHTML = state.insightsHTML;
            
            const qualitativeReportContainer = document.getElementById('qualitative-report-container');
            if (qualitativeReportContainer) {
                 qualitativeReportContainer.classList.add('hidden');
            }

            generateCharts();
            reportActions.classList.remove('hidden');
        }

        // ç”Ÿæˆå›¾è¡¨
        function generateCharts() {
            // æ¸…é™¤æ—§å›¾è¡¨
            chartInstances.forEach(chart => chart.destroy());
            chartInstances = [];
            reportCharts.innerHTML = '';

            // åªæœ‰å®šé‡æ•°æ®å­˜åœ¨æ—¶æ‰ç”Ÿæˆå›¾è¡¨
            if (state.simulationResults.length === 0) return;

            const allQuestions = [...(state.questionnaire.mainBody || []), ...(state.questionnaire.demographics || [])];
            allQuestions.forEach((q) => {
                if (q.questionType === 'single-choice' || q.questionType === 'multiple-choice') {
                    const chartContainer = document.createElement('div');
                    chartContainer.className = 'p-4 border border-gray-700 rounded-lg bg-gray-900/50';
                    const title = document.createElement('h4');
                    title.className = 'text-lg font-semibold mb-2 text-center text-gray-300';
                    title.textContent = q.questionText;
                    const canvas = document.createElement('canvas');
                    chartContainer.append(title, canvas);
                    reportCharts.appendChild(chartContainer);

                    const counts = {};
                    let totalRespondentsForQuestion = 0;
                    state.simulationResults.forEach(res => {
                        const answerObj = res.answers.find(a => a.questionId === q.questionId);
                        if (answerObj && answerObj.answer) {
                            totalRespondentsForQuestion++;
                            if (Array.isArray(answerObj.answer)) {
                                answerObj.answer.forEach(opt => { counts[opt] = (counts[opt] || 0) + 1; });
                            } else {
                                counts[answerObj.answer] = (counts[answerObj.answer] || 0) + 1;
                            }
                        }
                    });

                    const totalBase = q.questionType === 'multiple-choice' ? state.simulationResults.length : totalRespondentsForQuestion;
                    if (totalBase === 0) return;

                    const labels = Object.keys(counts);
                    const percentageData = labels.map(label => ((counts[label] / totalBase) * 100).toFixed(1));
                    const backgroundColors = labels.map((_, i) => `hsl(${(i * 200 / labels.length + 220)}, 70%, 60%)`);
                    
                    const newChart = new Chart(canvas, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{ label: T('chart_label_percentage'), data: percentageData, backgroundColor: backgroundColors }]
                        },
                        options: {
                            indexAxis: 'y', responsive: true,
                            scales: {
                                x: { beginAtZero: true, max: 100, ticks: { color: '#9ca3af', callback: (v) => v + "%" } },
                                y: { ticks: { color: '#9ca3af' } }
                            },
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const originalCount = counts[context.label];
                                            return `${context.parsed.x}% (${originalCount}${T('chart_tooltip_people')})`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                    chartInstances.push(newChart);
                }
            });
        }

        // é‡å¯åº”ç”¨
        function handleRestart() {
            window.location.hash = '';
            Object.assign(state, {
                currentStep: 1, researchGoal: '', researchStrategies: '', questionnaire: null, recruitedUsers: [], simulationResults: [], insightsHTML: '',
            });
            researchGoalInitialInput.value = '';
            researchGoalFinalInput.value = '';
            strategiesContainer.innerHTML = '';
            recruitedUsersContainer.innerHTML = '';
            reportCharts.innerHTML = '';
            reportInsights.innerHTML = '';
            const qualitativeReportContainer = document.getElementById('qualitative-report-container');
            if (qualitativeReportContainer) {
                 qualitativeReportContainer.classList.add('hidden');
            }
            shareLinkContainer.classList.add('hidden');
            progressBar.style.width = '0%';
            switchStep(1);
        }

        // ä¸‹è½½æŠ¥å‘Šä¸º PDF
        async function handleDownloadPDF() {
            const element = document.getElementById('report-body');
            showLoader(true, 'loader_generating_pdf');
            
            try {
                // æš‚æ—¶ä¿®æ”¹ Chart.js é¢œè‰²ä»¥é€‚åº”ç™½è‰²èƒŒæ™¯çš„ PDF
                Chart.defaults.color = '#374151'; 
                Chart.defaults.animation = false;
                generateCharts(); 

                const filename = T('pdf_filename', { title: state.questionnaire.title || 'Untitled' });
                const opt = {
                    margin: 1,
                    filename: filename,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true, backgroundColor: '#ffffff' },
                    jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
                };
                
                await html2pdf().set(opt).from(element).save();

            } catch(error) {
                console.error("PDF generation failed:", error);
                showModal("modal_pdf_fail");
            } finally {
                // æ¢å¤ Chart.js é»˜è®¤é¢œè‰²å’ŒåŠ¨ç”»
                Chart.defaults.color = originalChartColor;
                Chart.defaults.animation = true;
                generateCharts(); 
                showLoader(false);
            }
        }
        
        // --- é—®å·ç¼–è¾‘åŠŸèƒ½ ---
        function openQuestionnaireEditor() {
            if (!state.questionnaire) {
                showModal('modal_no_initial_goal');
                return;
            }
            questionnaireEditorContainer.innerHTML = '';
            
            ['screener', 'mainBody', 'demographics'].forEach(sectionKey => {
                const section = state.questionnaire[sectionKey];
                if (section && section.length > 0) {
                    section.forEach(q => {
                        const questionEditor = document.createElement('div');
                        questionEditor.className = 'p-4 rounded-lg bg-gray-800 border border-gray-700';
                        
                        // é—®é¢˜æ–‡æœ¬è¾“å…¥æ¡†
                        const questionTitleLabel = document.createElement('label');
                        questionTitleLabel.className = 'block text-sm font-medium text-gray-400';
                        questionTitleLabel.textContent = T('modal_edit_question_title');
                        const questionTitleInput = document.createElement('input');
                        questionTitleInput.type = 'text';
                        questionTitleInput.className = 'form-input mt-1 mb-2';
                        questionTitleInput.value = q.questionText;
                        questionEditor.appendChild(questionTitleLabel);
                        questionEditor.appendChild(questionTitleInput);

                        // é€‰é¡¹æ–‡æœ¬åŒºåŸŸ
                        if (q.options) {
                            const optionsTitleLabel = document.createElement('label');
                            optionsTitleLabel.className = 'block text-sm font-medium text-gray-400';
                            optionsTitleLabel.textContent = T('modal_edit_options_title');
                            const optionsTextarea = document.createElement('textarea');
                            optionsTextarea.className = 'form-input h-24 mt-1';
                            optionsTextarea.value = q.options.join('\n');
                            questionEditor.appendChild(optionsTitleLabel);
                            questionEditor.appendChild(optionsTextarea);
                        } else {
                            const openEndedText = document.createElement('p');
                            openEndedText.className = 'text-gray-500 text-sm';
                            openEndedText.textContent = T('modal_edit_open_ended');
                            questionEditor.appendChild(openEndedText);
                        }
                        
                        questionEditor.dataset.questionId = q.questionId;
                        questionEditor.dataset.questionType = q.questionType;
                        questionnaireEditorContainer.appendChild(questionEditor);
                    });
                }
            });
            
            questionnaireModal.classList.remove('hidden');
        }

        function saveQuestionnaireChanges() {
            const updatedQuestionnaire = JSON.parse(JSON.stringify(state.questionnaire));
            const questionEditors = document.querySelectorAll('#questionnaire-editor-container > div');
            
            questionEditors.forEach(editor => {
                const questionId = editor.dataset.questionId;
                const questionTitleInput = editor.querySelector('input');
                const optionsTextarea = editor.querySelector('textarea');
                
                const allQuestions = [...updatedQuestionnaire.screener, ...updatedQuestionnaire.mainBody, ...updatedQuestionnaire.demographics];
                const questionToUpdate = allQuestions.find(q => q.questionId === questionId);
                
                if (questionToUpdate) {
                    if (questionTitleInput) {
                        questionToUpdate.questionText = questionTitleInput.value;
                    }
                    if (optionsTextarea) {
                        questionToUpdate.options = optionsTextarea.value.split('\n').map(opt => opt.trim()).filter(opt => opt);
                    }
                }
            });
            
            state.questionnaire = updatedQuestionnaire;
            questionnaireModal.classList.add('hidden');
        }

        // --- Firebase/åˆ†äº«åŠŸèƒ½ ---
        async function handleShareReport() {
            if (!state.isAuthReady) {
                showModal('modal_process_fail', { message: 'Authentication not ready.' });
                return;
            }

            const shareData = {
                researchGoal: state.researchGoal,
                questionnaire: state.questionnaire,
                simulationResults: state.simulationResults,
                insightsHTML: state.insightsHTML,
                lang: state.currentLanguage
            };

            showLoader(true, 'loader_saving_report');

            try {
                // å°†æ•°æ®ä¿å­˜åˆ° Firestore
                const reportsCollectionRef = window.firebase.collection(state.db, 'artifacts', state.appId, 'public', 'data', 'reports');
                const newReportRef = window.firebase.doc(reportsCollectionRef); // è‡ªåŠ¨ç”ŸæˆID
                await window.firebase.setDoc(newReportRef, shareData);

                // åˆ›å»ºå¹¶æ˜¾ç¤ºåˆ†äº«é“¾æ¥
                const url = `${window.location.href.split('#')[0]}#reportId=${newReportRef.id}`;
                shareLinkInput.value = url;
                shareLinkContainer.classList.remove('hidden');
                showLoader(false);
            } catch (e) {
                console.error("Error saving report:", e);
                showModal('modal_process_fail', { message: 'Failed to save report to cloud.' });
                showLoader(false);
            }
        }

        async function loadReportFromURL() {
            if (!state.isAuthReady) return;

            const urlParams = new URLSearchParams(window.location.hash.substring(1));
            const reportId = urlParams.get('reportId');

            if (reportId) {
                showLoader(true, 'loader_loading_report');
                try {
                    const reportRef = window.firebase.doc(state.db, 'artifacts', state.appId, 'public', 'data', 'reports', reportId);
                    const reportSnap = await window.firebase.getDoc(reportRef);
                    if (reportSnap.exists()) {
                        const sharedData = reportSnap.data();
                        
                        if (sharedData.lang) {
                            switchLanguage(sharedData.lang);
                        }

                        Object.assign(state, sharedData);
                        
                        switchStep(5);
                        renderReportFromState();
                    } else {
                        showModal("modal_bad_link");
                        window.location.hash = '';
                        switchStep(1);
                    }
                } catch (error) {
                    showModal("modal_bad_link");
                    window.location.hash = '';
                    switchStep(1);
                } finally {
                    showLoader(false);
                }
            } else {
                switchStep(1);
            }
        }

        // å¤åˆ¶åˆ†äº«é“¾æ¥åˆ°å‰ªè´´æ¿
        function copyLinkToClipboard() {
            shareLinkInput.select();
            document.execCommand('copy');
            copyLinkBtn.textContent = T('copy_link_btn_copied');
            setTimeout(() => { copyLinkBtn.textContent = T('copy_link_btn'); }, 2000);
        }

        // --- åˆå§‹åŒ–å’Œäº‹ä»¶ç›‘å¬å™¨ ---
        function initFirebase() {
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
            if (!firebaseConfig) {
                console.error("Firebase config is not available.");
                return;
            }
            const app = window.firebase.initializeApp(firebaseConfig);
            auth = window.firebase.getAuth(app);
            db = window.firebase.getFirestore(app);
            state.db = db;
            state.auth = auth;

            window.firebase.onAuthStateChanged(auth, async (user) => {
                if (!user) {
                    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    if (initialAuthToken) {
                        await window.firebase.signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await window.firebase.signInAnonymously(auth);
                    }
                }
                state.isAuthReady = true;
                loadReportFromURL();
            });
        }

        optimizeGoalBtn.addEventListener('click', handleOptimizeGoal);
        generateBtn.addEventListener('click', handleGenerateAndRecruit);
        // ç›´æ¥è¿›å…¥å®šé‡ç ”ç©¶æ¨¡æ‹Ÿ
        proceedToDataCollectionBtn.addEventListener('click', handleStartDataCollection);
        restartBtn.addEventListener('click', handleRestart);
        downloadPdfBtn.addEventListener('click', handleDownloadPDF);
        shareReportBtn.addEventListener('click', handleShareReport);
        copyLinkBtn.addEventListener('click', copyLinkToClipboard);
        editQuestionnaireBtn.addEventListener('click', openQuestionnaireEditor);
        saveQuestionnaireBtn.addEventListener('click', saveQuestionnaireChanges);
        closeModalBtn.addEventListener('click', () => questionnaireModal.classList.add('hidden'));
        
        langSwitchToggle.addEventListener('click', () => {
            langSwitchMenu.classList.toggle('hidden');
        });

        langSwitchMenu.addEventListener('click', (e) => {
            const langOption = e.target.closest('.lang-option');
            if (langOption) {
                e.preventDefault();
                const newLang = langOption.dataset.lang;
                switchLanguage(newLang);
                langSwitchMenu.classList.add('hidden');
            }
        });

        window.addEventListener('click', (e) => {
            if (!langSwitchContainer.contains(e.target)) {
                langSwitchMenu.classList.add('hidden');
            }
        });

        window.addEventListener('load', () => {
            initFirebase();
            switchLanguage('zh');
        });
    </script>
</body>
</html>
