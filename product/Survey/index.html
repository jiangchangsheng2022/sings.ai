<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 用户研究模拟器 - sings.ai</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0D0D1B;
            color: #E0E0E0;
        }
        .gradient-text {
            background: linear-gradient(90deg, #8A2BE2, #4F46E5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
        }
        .step-section {
            background-color: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 2.5rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2), 0 0 15px rgba(106, 77, 255, 0.1);
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }
        .hidden-step {
            opacity: 0;
            transform: translateY(20px);
            display: none;
        }
        .visible-step {
            opacity: 1;
            transform: translateY(0);
            display: block;
        }
        .btn-primary {
            background: linear-gradient(90deg, #8A2BE2, #4F46E5);
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(106, 77, 255, 0.4);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 25px rgba(106, 77, 255, 0.7);
        }
        .btn-primary:disabled {
            background: #374151;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        .btn-secondary {
            background-color: rgba(255, 255, 255, 0.1);
            color: #d1d5db;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: background-color 0.3s;
        }
        .btn-secondary:hover {
            background-color: rgba(255, 255, 255, 0.15);
        }
        .loader-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(13, 13, 27, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 50;
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            transition: opacity 0.3s ease;
        }
        .ai-thinking-animation {
            width: 80px; height: 80px; position: relative;
        }
        .ai-thinking-animation .dot {
            position: absolute; width: 10px; height: 10px; background: #fff; border-radius: 50%; animation: pulse 1.5s infinite ease-in-out;
        }
        .ai-thinking-animation .dot1 { top: 0; left: 35px; }
        .ai-thinking-animation .dot2 { top: 25px; left: 10px; animation-delay: -0.2s; }
        .ai-thinking-animation .dot3 { top: 25px; left: 60px; animation-delay: 0.2s; }
        .ai-thinking-animation .dot4 { top: 50px; left: 35px; animation-delay: -0.4s; }
        .ai-thinking-animation .dot5 { top: 15px; left: 35px; background: #8A2BE2; animation-delay: -0.6s; }
        @keyframes pulse {
            0%, 100% { transform: scale(0.5); opacity: 0.5; }
            50% { transform: scale(1.2); opacity: 1; }
        }
        .loader-text {
            margin-top: 20px; color: #e0e0e0; font-size: 1rem; letter-spacing: 1px;
        }
        .form-input, textarea {
            width: 100%; padding: 0.75rem 1rem; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; background-color: rgba(255, 255, 255, 0.05); color: #e0e0e0; transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus, textarea:focus {
            outline: none; border-color: #8A2BE2; box-shadow: 0 0 0 2px rgba(138, 43, 226, 0.5);
        }
        .user-card {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        .user-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(138, 43, 226, 0.2), 0 4px 6px -4px rgba(138, 43, 226, 0.1);
        }
        .glass-morphism {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .gradient-button {
            background-image: linear-gradient(to right, #4F46E5, #3B82F6);
            transition: all 0.3s ease;
        }
        .gradient-button:hover {
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.5);
        }
    </style>
</head>
<body class="antialiased">

    <nav class="fixed top-0 left-0 right-0 z-50 p-4">
        <div class="container mx-auto glass-morphism rounded-xl p-2 px-4 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <a href="https://sings.ai/#" class="flex items-center text-gray-300 hover:text-white transition-colors">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    返回主页
                </a>
                <a href="https://sings.ai/#" class="text-xl font-bold text-white">sings.ai</a>
            </div>
            <div class="hidden md:flex items-center space-x-8">
                <a href="#" class="text-gray-300 hover:text-white transition-colors">产品</a>
                <a href="#" class="text-gray-300 hover:text-white transition-colors">方案</a>
                <a href="#" class="text-gray-300 hover:text-white transition-colors">资源</a>
                <a href="#" class="text-gray-300 hover:text-white transition-colors">定价</a>
            </div>
            <div class="hidden md:flex items-center space-x-4">
                <a href="#" class="text-gray-300 hover:text-white transition-colors">登录</a>
                <a href="#" class="gradient-button text-white font-semibold py-2 px-4 rounded-lg">免费开始</a>
            </div>
            <div class="md:hidden">
                <button class="text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
            </div>
        </div>
    </nav>

    <div id="loader-overlay" class="loader-overlay" style="display: none;">
        <div class="ai-thinking-animation">
            <div class="dot dot1"></div><div class="dot dot2"></div><div class="dot dot3"></div><div class="dot dot4"></div><div class="dot dot5"></div>
        </div>
        <div id="loader-text" class="loader-text">AI 正在思考...</div>
    </div>

    <div class="container mx-auto max-w-5xl px-4 md:px-8 pb-4 md:pb-8 pt-32 md:pt-40">
        <header class="text-center my-10">
            <h1 class="text-3xl md:text-5xl font-extrabold text-white">AI 用户研究模拟器</h1>
            <p class="mt-3 text-lg text-gray-400">由 <span class="gradient-text font-semibold">SiliconFlow</span> 模型驱动的定量研究工具</p>
        </header>

        <main>
            <div class="grid grid-cols-5 gap-2 md:gap-4 mb-8 p-4 bg-gray-900/50 rounded-lg border border-gray-800">
                <div id="progress-step-1" class="text-center text-indigo-400 font-semibold">
                    <div class="w-8 h-8 mx-auto rounded-full bg-indigo-500 text-white flex items-center justify-center mb-1">1</div>
                    <p class="text-xs md:text-sm">输入需求</p>
                </div>
                <div id="progress-step-2" class="text-center text-gray-500">
                    <div class="w-8 h-8 mx-auto rounded-full bg-gray-700 flex items-center justify-center mb-1">2</div>
                    <p class="text-xs md:text-sm">确认目标</p>
                </div>
                <div id="progress-step-3" class="text-center text-gray-500">
                    <div class="w-8 h-8 mx-auto rounded-full bg-gray-700 flex items-center justify-center mb-1">3</div>
                    <p class="text-xs md:text-sm">用户招募</p>
                </div>
                <div id="progress-step-4" class="text-center text-gray-500">
                    <div class="w-8 h-8 mx-auto rounded-full bg-gray-700 flex items-center justify-center mb-1">4</div>
                    <p class="text-xs md:text-sm">数据处理</p>
                </div>
                <div id="progress-step-5" class="text-center text-gray-500">
                    <div class="w-8 h-8 mx-auto rounded-full bg-gray-700 flex items-center justify-center mb-1">5</div>
                    <p class="text-xs md:text-sm">生成报告</p>
                </div>
            </div>

            <section id="step-1" class="step-section visible-step">
                <h2 class="text-2xl font-bold mb-4">第一步：输入初步研究需求</h2>
                <p class="mb-4 text-gray-400">请在此输入您宽泛的研究想法或问题，AI 将在下一步帮您优化。</p>
                <textarea id="research-goal-initial" class="h-40" placeholder="例如：我想了解一下年轻人对智能手表的看法。"></textarea>
                <button id="optimize-goal-btn" class="btn-primary mt-4 w-full font-bold py-3 px-4 rounded-md flex items-center justify-center disabled:opacity-50">
                    <span>✨ 生成优化建议</span>
                    <div class="ai-thinking-animation w-6 h-6 ml-3 hidden"></div>
                </button>
                <div id="error-step-1" class="text-red-500 mt-4 text-sm hidden"></div>
            </section>

            <section id="step-2" class="step-section hidden-step">
                <h2 class="text-2xl font-bold mb-4">第二步：确认研究目标并生成问卷</h2>
                <p class="mb-4 text-gray-400">这是 AI 为您优化的研究目标。您可以直接使用，或根据需要进行修改，然后生成专业问卷和招募用户。</p>
                <textarea id="research-goal-final" class="h-40"></textarea>
                <button id="generate-questionnaire-btn" class="btn-primary mt-4 w-full font-bold py-3 px-4 rounded-md flex items-center justify-center disabled:bg-gray-400">
                    <span>确认目标，生成问卷并招募用户</span>
                    <div class="ai-thinking-animation w-6 h-6 ml-3 hidden"></div>
                </button>
                <div id="error-step-2" class="text-red-500 mt-4 text-sm hidden"></div>
            </section>

            <section id="step-3" class="step-section hidden-step">
                <h2 class="text-2xl font-bold mb-4">第三步：用户招募</h2>
                <p class="mb-4 text-gray-400">已根据您的研究目标成功招募以下虚拟用户。他们将参与后续的问卷填写。</p>
                <div id="recruited-users-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-96 overflow-y-auto"></div>
                <button id="proceed-to-simulation-btn" class="btn-primary mt-6 w-full font-bold py-3 px-4 rounded-md flex items-center justify-center disabled:bg-gray-400 hidden">
                    <span>开始数据处理</span>
                    <div class="ai-thinking-animation w-6 h-6 ml-3 hidden"></div>
                </button>
                <div id="error-step-3" class="text-red-500 mt-4 text-sm hidden"></div>
            </section>

            <section id="step-4" class="step-section hidden-step">
                <h2 class="text-2xl font-bold mb-4">第四步：数据处理</h2>
                <p class="mb-4 text-gray-400">AI 正在模拟已招募的用户填写问卷并处理数据，请稍候...</p>
                <div class="mt-4 text-center text-gray-400">
                    <p id="progress-text">正在处理数据...</p>
                    <div class="w-full bg-gray-700 rounded-full h-4 mt-2">
                        <div id="progress-bar" class="bg-green-600 h-4 rounded-full text-xs font-medium text-blue-100 text-center p-0.5 leading-none" style="width: 0%; background: linear-gradient(90deg, #8A2BE2, #4F46E5);">0%</div>
                    </div>
                </div>
                <div id="error-step-4" class="text-red-500 mt-4 text-sm hidden"></div>
            </section>

            <section id="step-5" class="step-section hidden-step">
                <h2 class="text-2xl font-bold mb-4">第五步：用户研究报告</h2>
                <div id="report-content">
                    <div id="report-body">
                        <div class="mb-8 p-6 bg-gray-900/50 border-l-4 border-indigo-500 rounded-r-lg">
                            <h3 class="text-xl font-semibold text-indigo-300">研究背景</h3>
                            <p id="report-goal" class="text-gray-300 mt-2"></p>
                        </div>
                        <div class="mb-8">
                            <h3 class="text-xl font-semibold text-gray-200 mb-4">关键洞察</h3>
                            <div id="report-insights" class="prose prose-invert max-w-none p-4 bg-gray-900/50 rounded-md"></div>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-gray-200 mb-4">数据可视化图表</h3>
                            <div id="report-charts" class="space-y-8"></div>
                        </div>
                    </div>
                </div>
                <div id="report-actions" class="mt-8">
                    <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
                        <button id="download-pdf-btn" class="btn-secondary w-full justify-center">下载PDF报告</button>
                        <button id="share-report-btn" class="btn-secondary w-full justify-center">分享报告</button>
                    </div>
                    <div id="share-link-container" class="mt-4 hidden">
                        <label for="share-link-input" class="block text-sm font-medium text-gray-400">分享链接:</label>
                        <div class="mt-1 flex rounded-md shadow-sm">
                            <input type="text" id="share-link-input" class="form-input flex-1 block w-full rounded-none rounded-l-md" readonly>
                            <button id="copy-link-btn" class="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-600 bg-gray-700 text-gray-300 text-sm hover:bg-gray-600">复制</button>
                        </div>
                    </div>
                </div>
                <button id="restart-btn" class="btn-primary mt-4 w-full justify-center">重新开始</button>
            </section>
        </main>
    </div>

    <script>
        const state = {
            currentStep: 1, researchGoal: '', questionnaire: null, recruitedUsers: [], simulationResults: [], insightsHTML: '',
        };
        const config = {
            siliconflow: {
                apiKey: 'sk-xifmrwnarxegowpdpwjmbpiodhjawjtacbkgtkoygpgszhec',
                apiUrl: 'https://api.siliconflow.cn/v1/chat/completions',
                model: 'alibaba/Qwen2-7B-Instruct',
            },
            simulationCount: 30,
        };

        const stepSections = Array.from({length: 5}, (_, i) => document.getElementById(`step-${i + 1}`));
        const optimizeGoalBtn = document.getElementById('optimize-goal-btn');
        const generateBtn = document.getElementById('generate-questionnaire-btn');
        const proceedToSimBtn = document.getElementById('proceed-to-simulation-btn');
        const restartBtn = document.getElementById('restart-btn');
        const downloadPdfBtn = document.getElementById('download-pdf-btn');
        const shareReportBtn = document.getElementById('share-report-btn');
        const copyLinkBtn = document.getElementById('copy-link-btn');
        const researchGoalInitialInput = document.getElementById('research-goal-initial');
        const researchGoalFinalInput = document.getElementById('research-goal-final');
        const recruitedUsersContainer = document.getElementById('recruited-users-container');
        const progressText = document.getElementById('progress-text');
        const progressBar = document.getElementById('progress-bar');
        const reportGoal = document.getElementById('report-goal');
        const reportInsights = document.getElementById('report-insights');
        const reportCharts = document.getElementById('report-charts');
        const reportActions = document.getElementById('report-actions');
        const shareLinkContainer = document.getElementById('share-link-container');
        const shareLinkInput = document.getElementById('share-link-input');
        const errorElements = Array.from({length: 4}, (_, i) => document.getElementById(`error-step-${i + 1}`));
        const loaderOverlay = document.getElementById('loader-overlay');
        const loaderText = document.getElementById('loader-text');

        // Store original chart color for PDF export/restore
        const originalChartColor = Chart.defaults.color;

        function updateProgressIndicator(step) {
            const progressSteps = document.querySelectorAll('[id^="progress-step-"]');
            progressSteps.forEach((s, index) => {
                const circle = s.querySelector('div');
                if (index < step) {
                    s.classList.remove('text-gray-500');
                    s.classList.add('text-indigo-400', 'font-semibold');
                    circle.classList.remove('bg-gray-700');
                    circle.classList.add('bg-indigo-500', 'text-white');
                } else {
                    s.classList.remove('text-indigo-400', 'font-semibold');
                    s.classList.add('text-gray-500');
                    circle.classList.remove('bg-indigo-500', 'text-white');
                    circle.classList.add('bg-gray-700');
                }
            });
        }

        function switchStep(stepToShow) {
            state.currentStep = stepToShow;
            stepSections.forEach((section, index) => {
                section.classList.toggle('visible-step', index + 1 === stepToShow);
                section.classList.toggle('hidden-step', index + 1 !== stepToShow);
            });
            updateProgressIndicator(stepToShow);
        }

        function setButtonLoading(button, isLoading) {
            const textSpan = button.querySelector('span');
            const loader = button.querySelector('.ai-thinking-animation');
            button.disabled = isLoading;
            if (textSpan) textSpan.style.display = isLoading ? 'none' : 'inline-block';
            if (loader) loader.style.display = isLoading ? 'block' : 'none';
        }
        
        function showLoader(show, text = 'AI 正在思考...') {
            loaderText.textContent = text;
            loaderOverlay.style.display = show ? 'flex' : 'none';
        }

        function showModal(message) {
            let existingModal = document.getElementById('custom-modal');
            if (existingModal) existingModal.remove();
            const modalOverlay = document.createElement('div');
            modalOverlay.id = 'custom-modal';
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4';
            modalOverlay.onclick = () => modalOverlay.remove();
            const modalContent = document.createElement('div');
            modalContent.className = 'bg-gray-900 border border-gray-700 text-white p-6 rounded-lg shadow-lg max-w-sm mx-auto text-center';
            modalContent.onclick = (e) => e.stopPropagation();
            const messageP = document.createElement('p');
            messageP.textContent = message;
            messageP.className = 'mb-6 text-lg';
            const closeButton = document.createElement('button');
            closeButton.textContent = '好的';
            closeButton.className = 'btn-primary w-full';
            closeButton.onclick = () => modalOverlay.remove();
            modalContent.append(messageP, closeButton);
            modalOverlay.appendChild(modalOverlay);
            document.body.appendChild(modalOverlay);
        }

        async function callAI(prompt, retries = 3) {
            const { apiKey, apiUrl, model } = config.siliconflow;
            const payload = { model, messages: [{ role: 'user', content: prompt }], max_tokens: 4096 };

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`API Error: ${response.status} ${await response.text()}`);
                    const result = await response.json();
                    if (result.choices && result.choices.length > 0) {
                        let content = result.choices[0].message.content.trim();
                        if (content.startsWith("```json")) {
                            content = content.substring(7);
                        }
                        if (content.endsWith("```")) {
                            content = content.slice(0, -3);
                        }
                        return content.trim();
                    } else throw new Error('API returned no valid content.');
                } catch (error) {
                    console.error(`Attempt ${i + 1} failed:`, error);
                    if (i === retries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
        }

        async function handleOptimizeGoal() {
            const currentGoal = researchGoalInitialInput.value.trim();
            if (!currentGoal) return showModal('请先输入一个初步的研究目标。');
            setButtonLoading(optimizeGoalBtn, true);
            showLoader(true, '正在优化研究目标...');
            const prompt = `作为一名顶尖的用户研究策略师，请将以下这个较为宽泛的研究想法，优化成一个更专业、更聚焦、更具可操作性的研究目标。请直接返回优化后的文本，无需任何额外解释。\n\n原始想法：\n"${currentGoal}"`;
            try {
                const optimizedGoal = await callAI(prompt);
                researchGoalFinalInput.value = optimizedGoal;
                switchStep(2);
            } catch (error) {
                showModal(`AI 优化失败: ${error.message}`);
            } finally {
                setButtonLoading(optimizeGoalBtn, false);
                showLoader(false);
            }
        }

        async function handleGenerateAndRecruit() {
            state.researchGoal = researchGoalFinalInput.value.trim();
            if (!state.researchGoal) return showModal('研究目标不能为空。');
            setButtonLoading(generateBtn, true);
            switchStep(3);
            showLoader(true, '正在生成问卷并招募用户...');

            try {
                const [questionnaireText, usersText] = await Promise.all([generateQuestionnaire(), recruitUsers()]);
                
                state.questionnaire = JSON.parse(questionnaireText);
                state.recruitedUsers = JSON.parse(usersText);

                displayRecruitedUsers();
                proceedToSimBtn.classList.remove('hidden');
            } catch (error) {
                const errorMessage = error instanceof SyntaxError ? `AI返回的数据格式不正确，无法解析: ${error.message}` : `处理失败: ${error.message}`;
                showModal(errorMessage);
                console.error('Error in handleGenerateAndRecruit:', error, {questionnaireText, usersText});
                switchStep(2); 
            } finally {
                setButtonLoading(generateBtn, false);
                showLoader(false);
            }
        }

        function generateQuestionnaire() {
            const prompt = `作为一名资深的用户研究专家，请根据以下研究目的，设计一份专业的定量研究问卷。\n研究目的："${state.researchGoal}"\n\n你的输出必须是一个严格遵循以下JSON格式的字符串，不要包含任何额外的解释或Markdown标记，必须以 \`\`\`json 开始和结束：\n\`\`\`json\n{\n  "title": "关于...的研究问卷",\n  "screener": [\n    { "questionId": "s1", "questionText": "您在过去一年内是否使用或购买过相关产品/服务？", "questionType": "single-choice", "options": ["是", "否"] }\n  ],\n  "mainBody": [\n    { "questionId": "m1", "questionText": "您最常使用的品牌是什么？", "questionType": "single-choice", "options": ["品牌A", "品牌B", "品牌C", "其他"] },\n    { "questionId": "m2", "questionText": "您选择该品牌的主要原因是什么？(可多选)", "questionType": "multiple-choice", "options": ["价格实惠", "性能强大", "设计美观", "朋友推荐", "广告影响"] }\n  ],\n  "demographics": [\n    { "questionId": "d1", "questionText": "您的性别是？", "questionType": "single-choice", "options": ["男", "女", "其他"] },\n    { "questionId": "d2", "questionText": "您的年龄段是？", "questionType": "single-choice", "options": ["18岁以下", "18-25岁", "26-35岁", "36-45岁", "45岁以上"] },\n    { "questionId": "d3", "questionText": "您的职业是？", "questionType": "single-choice", "options": ["学生", "技术/IT", "设计/艺术", "教育/科研", "医疗/健康", "自由职业", "其他"] }\n  ]\n}\n\`\`\`\n请确保问题设计专业、逻辑严谨，并完整覆盖甄别、主体和个人信息三个部分。`;
            return callAI(prompt);
        }

        function recruitUsers() {
            const prompt = `作为一名专业的市场研究招募专员，请根据以下研究目标，为我生成 ${config.simulationCount} 位符合条件的虚拟用户画像。\n\n研究目标：\n"${state.researchGoal}"\n\n你的输出必须是一个严格的JSON数组，数组中包含 ${config.simulationCount} 个对象。每个对象都必须包含 "name" (一个常见的中文名), "age" (一个数字), "gender" (男或女), 和 "bio" (一段20-40字的生动自我介绍，需符合其画像特征)。不要包含任何额外的解释或Markdown标记，必须以 \`\`\`json 开始和结束：\n\`\`\`json\n[\n  {\n    "name": "李明",\n    "age": 28,\n    "gender": "男",\n    "bio": "我是一名在北京工作的软件工程师，平时喜欢研究各种数码产品，对新技术很敏感，业余时间会去健身和爬山。"\n  },\n  {\n    "name": "王秀英",\n    "age": 22,\n    "gender": "女",\n    "bio": "我是上海一所大学的设计系学生，热爱时尚和艺术，喜欢用Vlog记录生活，对产品的颜值和设计感有很高的要求。"\n  }\n]\n\`\`\`\n请确保生成的用户画像多样化，并能覆盖研究目标可能涉及的不同用户群体。`;
            return callAI(prompt);
        }

        function displayRecruitedUsers() {
            recruitedUsersContainer.innerHTML = '';
            state.recruitedUsers.forEach((user, index) => {
                const card = document.createElement('div');
                card.className = 'user-card bg-gray-900/50 p-4 rounded-lg border border-gray-700 flex items-center space-x-4';
                const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}&background=252535&color=E0E0E0&font-size=0.5`;
                card.innerHTML = `<img src="${avatarUrl}" alt="用户头像" class="w-16 h-16 rounded-full border-2 border-gray-600"><div class="flex-1"><h4 class="font-bold text-lg text-indigo-400">${user.name}</h4><p class="text-sm text-gray-400 mb-2">${user.gender}, ${user.age}岁</p><p class="text-sm text-gray-300">${user.bio}</p></div>`;
                recruitedUsersContainer.appendChild(card);
                setTimeout(() => {
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, 100 * index);
            });
        }

        async function handleStartSimulation() {
            switchStep(4);
            state.simulationResults = [];
            for (let i = 0; i < state.recruitedUsers.length; i++) {
                const user = state.recruitedUsers[i];
                progressText.textContent = `正在处理用户数据 ${i + 1}/${state.recruitedUsers.length}: ${user.name}...`;
                const prompt = `你是一个高级数据模拟器。现在，请为以下这位已被招募的用户，填写这份问卷。 \n\n你的任务是生成一个JSON对象，代表这位用户的完整问卷回答。回答必须严格符合用户的个人简介(bio)和画像特征。\n\n[重要规则]：在生成JSON时，如果任何字符串值（特别是 "bio" 或 "answers"）内部包含双引号(")，你必须用反斜杠进行转义，例如 "他说: \\"你好\\""。这是一个强制性要求，以确保JSON的有效性。\n\n这是当前用户的信息：\n${JSON.stringify(user, null, 2)}\n\n这是需要填写的问卷：\n${JSON.stringify(state.questionnaire, null, 2)}\n\n你的输出必须是一个严格的、格式完全正确的JSON对象。不要包含任何额外的解释或Markdown标记，必须以 \`\`\`json 开始和结束：\n\`\`\`json\n{\n    "respondentId": "user-${i + 1}",\n    "persona": ${JSON.stringify(user)},\n    "answers": [\n      { "questionId": "s1", "answer": "是" },\n      { "questionId": "m1", "answer": "品牌A" },\n      { "questionId": "m2", "answer": ["性能强大"] },\n      { "questionId": "m3", "answer": "满意" },\n      { "questionId": "d1", "answer": "男" },\n      { "questionId": "d2", "answer": "26-35岁" },\n      { "questionId": "d3", "answer": "技术/IT" }\n    ]\n}\n\`\`\`\n请确保回答与用户的个人信息和简介高度一致。`;
                try {
                    const responseText = await callAI(prompt);
                    state.simulationResults.push(JSON.parse(responseText));
                    const progress = ((i + 1) / state.recruitedUsers.length) * 100;
                    progressBar.style.width = `${progress}%`;
                    progressBar.textContent = `${Math.round(progress)}%`;
                } catch (error) {
                    console.error(`模拟用户 ${user.name} 失败:`, error);
                    continue;
                }
            }
            progressText.textContent = `数据处理完成！共获得 ${state.simulationResults.length} 份有效数据。`;
            setTimeout(() => {
                switchStep(5);
                handleGenerateReport();
            }, 1000);
        }

        async function handleGenerateReport() {
            showLoader(true, '正在分析数据并生成洞察...');
            const dataSummary = summarizeDataForAI();
            const prompt = `作为一名资深的数据分析师，请分析以下关于“${state.questionnaire.title}”的问卷调查数据摘要...\n数据摘要：\n${dataSummary}\n...总结出3-5个最关键的市场洞察和商业建议...`;
            try {
                const insights = await callAI(prompt);
                state.insightsHTML = marked.parse(insights);
                renderReportFromState();
            } catch (error) {
                showModal(`无法生成洞察结论: ${error.message}`);
            } finally {
                showLoader(false);
            }
        }

        function renderReportFromState() {
            reportGoal.textContent = state.researchGoal;
            reportInsights.innerHTML = state.insightsHTML;
            generateCharts();
            reportActions.classList.remove('hidden');
        }

        function summarizeDataForAI() {
            let summary = `总样本量: ${state.simulationResults.length}份\n\n`;
            const allQuestions = [...(state.questionnaire.screener || []), ...(state.questionnaire.mainBody || []), ...(state.questionnaire.demographics || [])];
            allQuestions.forEach(q => {
                summary += `问题: "${q.questionText}"\n`;
                const counts = {};
                state.simulationResults.forEach(res => {
                    const answerObj = res.answers.find(a => a.questionId === q.questionId);
                    if (!answerObj || !answerObj.answer) return;
                    if (Array.isArray(answerObj.answer)) {
                        answerObj.answer.forEach(opt => { counts[opt] = (counts[opt] || 0) + 1; });
                    } else {
                        counts[answerObj.answer] = (counts[answerObj.answer] || 0) + 1;
                    }
                });
                for (const [option, count] of Object.entries(counts)) {
                    summary += `- ${option}: ${count}票 (${((count / state.simulationResults.length) * 100).toFixed(1)}%)\n`;
                }
                summary += "\n";
            });
            return summary;
        }

        function generateCharts() {
            reportCharts.innerHTML = '';
            const allQuestions = [...(state.questionnaire.mainBody || []), ...(state.questionnaire.demographics || [])];
            allQuestions.forEach((q) => {
                if (q.questionType === 'single-choice' || q.questionType === 'multiple-choice') {
                    const chartContainer = document.createElement('div');
                    chartContainer.className = 'p-4 border border-gray-700 rounded-lg bg-gray-900/50';
                    const title = document.createElement('h4');
                    title.className = 'text-lg font-semibold mb-2 text-center text-gray-300';
                    title.textContent = q.questionText;
                    const canvas = document.createElement('canvas');
                    chartContainer.append(title, canvas);
                    reportCharts.appendChild(chartContainer);

                    const counts = {};
                    let totalRespondentsForQuestion = 0;
                    state.simulationResults.forEach(res => {
                        const answerObj = res.answers.find(a => a.questionId === q.questionId);
                        if (answerObj && answerObj.answer) {
                            totalRespondentsForQuestion++;
                            if (Array.isArray(answerObj.answer)) {
                                answerObj.answer.forEach(opt => { counts[opt] = (counts[opt] || 0) + 1; });
                            } else {
                                counts[answerObj.answer] = (counts[answerObj.answer] || 0) + 1;
                            }
                        }
                    });

                    const totalBase = q.questionType === 'multiple-choice' ? state.simulationResults.length : totalRespondentsForQuestion;
                    if (totalBase === 0) return;

                    const labels = Object.keys(counts);
                    const percentageData = labels.map(label => ((counts[label] / totalBase) * 100).toFixed(1));
                    const backgroundColors = labels.map((_, i) => `hsl(${(i * 200 / labels.length + 220)}, 70%, 60%)`);
                    
                    new Chart(canvas, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{ label: '选择百分比 (%)', data: percentageData, backgroundColor: backgroundColors }]
                        },
                        options: {
                            indexAxis: 'y', responsive: true,
                            scales: {
                                x: { beginAtZero: true, max: 100, ticks: { color: '#9ca3af', callback: (v) => v + "%" } },
                                y: { ticks: { color: '#9ca3af' } }
                            },
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const originalCount = counts[context.label];
                                            return `${context.parsed.x}% (${originalCount}人)`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            });
        }

        function handleRestart() {
            window.location.hash = '';
            Object.assign(state, {
                currentStep: 1, researchGoal: '', questionnaire: null, recruitedUsers: [], simulationResults: [], insightsHTML: '',
            });
            researchGoalInitialInput.value = '';
            researchGoalFinalInput.value = '';
            recruitedUsersContainer.innerHTML = '';
            reportCharts.innerHTML = '';
            reportInsights.innerHTML = '';
            shareLinkContainer.classList.add('hidden');
            progressBar.style.width = '0%';
            switchStep(1);
        }

        // --- MODIFIED: PDF Download Function ---
        async function handleDownloadPDF() {
            const element = document.getElementById('report-body');
            showLoader(true, '正在生成PDF报告...');
            
            try {
                // Temporarily set chart colors for light background
                Chart.defaults.color = '#374151'; // Dark gray for text
                generateCharts(); // Redraw charts with new colors

                const opt = {
                    margin: 1,
                    filename: `AI用户研究报告-${state.questionnaire.title || '未命名'}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { 
                        scale: 2, 
                        useCORS: true, 
                        backgroundColor: '#ffffff' // Force white background
                    },
                    jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
                };

                // Temporarily disable animations for PDF generation
                Chart.defaults.animation = false;
                
                await html2pdf().set(opt).from(element).save();

            } catch(error) {
                console.error("PDF generation failed:", error);
                showModal("生成PDF报告时出错，请重试。");
            } finally {
                // Restore original chart colors and settings
                Chart.defaults.color = originalChartColor;
                Chart.defaults.animation = true;
                // Redraw charts with original colors for the webpage
                generateCharts(); 
                showLoader(false);
            }
        }

        function handleShareReport() {
            const shareData = {
                researchGoal: state.researchGoal,
                questionnaire: state.questionnaire,
                simulationResults: state.simulationResults,
                insightsHTML: state.insightsHTML
            };
            const jsonString = JSON.stringify(shareData);
            const compressed = pako.deflate(jsonString, { to: 'string' });
            const encoded = btoa(compressed);
            const url = `${window.location.href.split('#')[0]}#data=${encoded}`;
            shareLinkInput.value = url;
            shareLinkContainer.classList.remove('hidden');
        }

        function copyLinkToClipboard() {
            shareLinkInput.select();
            document.execCommand('copy');
            copyLinkBtn.textContent = '已复制!';
            setTimeout(() => { copyLinkBtn.textContent = '复制'; }, 2000);
        }

        async function loadReportFromURL() {
            if (window.location.hash.startsWith('#data=')) {
                showLoader(true, '正在加载分享的报告...');
                try {
                    const encodedData = window.location.hash.substring(6);
                    const compressed = atob(encodedData);
                    const jsonString = pako.inflate(compressed, { to: 'string' });
                    const sharedData = JSON.parse(jsonString);
                    Object.assign(state, sharedData);
                    switchStep(5);
                    renderReportFromState();
                } catch (error) {
                    showModal("分享链接无效或已损坏。");
                    window.location.hash = '';
                } finally {
                    showLoader(false);
                }
            } else {
                switchStep(1);
            }
        }

        optimizeGoalBtn.addEventListener('click', handleOptimizeGoal);
        generateBtn.addEventListener('click', handleGenerateAndRecruit);
        proceedToSimBtn.addEventListener('click', handleStartSimulation);
        restartBtn.addEventListener('click', handleRestart);
        downloadPdfBtn.addEventListener('click', handleDownloadPDF);
        shareReportBtn.addEventListener('click', handleShareReport);
        copyLinkBtn.addEventListener('click', copyLinkToClipboard);

        window.addEventListener('load', loadReportFromURL);
    </script>
</body>
</ht
