<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Talk Engine - sings.ai</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.2.12/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* 基础样式 */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0D0D1B;
            color: #E0E0E0;
            transition: background-color 0.3s, color 0.3s;
        }

        /* 渐变色文字 */
        .gradient-text {
            background: linear-gradient(90deg, #8A2BE2, #4F46E5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
        }

        /* 步骤卡片 */
        .step-card {
            background-color: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 2.5rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2), 0 0 15px rgba(106, 77, 255, 0.1);
            transition: all 0.3s ease-in-out;
            display: none;
            min-height: 50vh;
        }
        .step-card.active {
            display: block;
        }

        /* 进度条 */
        .progress-bar-bg {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .progress-bar-fill {
            background: linear-gradient(90deg, #8A2BE2, #4F46E5);
            transition: width 0.5s ease-in-out;
        }

        /* 按钮 */
        .btn-primary {
            background: linear-gradient(90deg, #8A2BE2, #4F46E5);
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(106, 77, 255, 0.4);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 25px rgba(106, 77, 255, 0.7);
        }
        .btn-primary:disabled {
            background: #374151;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        .btn-secondary {
            background-color: rgba(255, 255, 255, 0.1);
            color: #d1d5db;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: background-color 0.3s;
        }
        .btn-secondary:hover {
            background-color: rgba(255, 255, 255, 0.15);
        }
        .btn-link {
            color: #8A2BE2;
            text-decoration: underline;
            transition: color 0.3s;
        }
        .btn-link:hover {
            color: #4F46E5;
        }
        .outline-card.selected {
            border-color: #4F46E5;
            background-color: rgba(79, 70, 229, 0.1);
        }

        /* 加载动画 */
        .loader-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(13, 13, 27, 0.7);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 50;
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            transition: opacity 0.3s ease;
        }
        .spinner {
            width: 80px;
            height: 80px;
            border: 8px solid rgba(255, 255, 255, 0.1);
            border-top: 8px solid #8A2BE2;
            border-radius: 50%;
            animation: spin 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loader-text {
            margin-top: 20px;
            color: #e0e0e0;
            font-size: 1.2rem;
            letter-spacing: 1px;
            text-align: center;
        }
        .loader-dots {
            font-size: 1.5em;
            animation: dot-animation 1.5s linear infinite;
        }
        @keyframes dot-animation {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        /* 聊天气泡 */
        .chat-bubble {
            max-width: 75%;
            padding: 0.6rem 1rem;
            border-radius: 16px;
            word-wrap: break-word;
            display: flex;
            flex-direction: column;
            line-height: 1.6;
            animation: slideIn 0.3s ease-out;
        }
        .chat-bubble-right {
            background: linear-gradient(90deg, #8A2BE2, #4F46E5);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .chat-bubble-left {
            background-color: #374151;
            color: #e5e7eb;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        .chat-name {
            font-weight: 600;
            font-size: 0.8rem;
            margin-bottom: 0.2rem;
        }
        .chat-name-left {
            color: #9ca3af;
        }
        .chat-name-right {
            color: #dbeafe;
        }
        .typing-indicator-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 0.5rem;
            align-self: flex-start;
        }
        .typing-indicator span {
            height: 8px;
            width: 8px;
            float: left;
            margin: 0 1px;
            background-color: #9ca3af;
            display: block;
            border-radius: 50%;
            opacity: 0.4;
            animation: bob 1s infinite;
        }
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes bob {
            10% { transform: translateY(-5px); background-color: #e5e7eb; }
            50% { transform: translateY(0); background-color: #9ca3af; }
        }
        @keyframes slideIn {
            0% { transform: translateY(20px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        /* Markdown 渲染样式 */
        .report-content h2, .voc-content h2 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 0.5rem;
            color: #fff;
        }
        .report-content h3, .voc-content h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-top: 1.25rem;
            margin-bottom: 0.5rem;
            color: #e5e7eb;
        }
        .report-content p, .voc-content p {
            margin-bottom: 1rem;
            line-height: 1.75;
            color: #d1d5db;
        }
        .report-content ul, .voc-content ul {
            list-style-type: disc;
            padding-left: 1.5rem;
            margin-bottom: 1rem;
            color: #d1d5db;
        }
        .report-content li, .voc-content li {
            margin-bottom: 0.5rem;
        }
        .report-content blockquote {
            border-left: 4px solid #8A2BE2;
            padding-left: 1rem;
            margin: 1rem 0;
            color: #d1d5db;
            font-style: italic;
        }

        /* 表单元素 */
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #d1d5db;
        }
        .form-input, textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.05);
            color: #e0e0e0;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus, textarea:focus {
            outline: none;
            border-color: #8A2BE2;
            box-shadow: 0 0 0 2px rgba(138, 43, 226, 0.5);
        }

        /* 参与者卡片动画 */
        .participant-card {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }

        /* 玻璃拟态导航栏 */
        .glass-morphism {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* 语言切换器 */
        .lang-button {
            background-color: rgba(255, 255, 255, 0.1);
            color: #d1d5db;
            font-weight: 500;
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s;
        }
        .lang-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
        }
        .lang-dropdown-menu {
            background: #1f2937;
            border: 1px solid #374151;
        }
        .lang-dropdown-menu a:hover {
            background-color: #374151;
        }

        /* 自定义模态框 */
        #custom-modal .btn-primary {
            background: linear-gradient(90deg, #8A2BE2, #4F46E5);
            border: none;
        }
        .moderator-avatar, .user-avatar {
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: bold;
            color: white;
            flex-shrink: 0; /* Prevent avatar from shrinking */
        }
        .moderator-avatar {
            background: #4F46E5;
        }
        .user-avatar {
            background: #6B21A8;
        }

        /* 访谈追问输入框 */
        #ask-question-container {
            transition: opacity 0.3s ease;
        }
        .sentiment-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            margin-top: 0.5rem;
            font-size: 0.75rem;
            font-weight: bold;
            border-radius: 9999px;
        }
        .sentiment-positive { background-color: #10B981; color: white; }
        .sentiment-negative { background-color: #EF4444; color: white; }
        .sentiment-neutral { background-color: #9CA3AF; color: white; }
    </style>
</head>
<body class="antialiased">

    <!-- Loader Overlay with AI Animation -->
    <div id="loader-overlay" class="loader-overlay" style="display: none;">
        <div class="spinner"></div>
        <div id="loader-text" class="loader-text" data-key="loaderText">AI 正在思考...</div>
    </div>

    <!-- Navigation Bar -->
    <nav class="fixed top-0 left-0 right-0 z-50 p-4">
        <div class="container mx-auto glass-morphism rounded-xl p-2 px-4 flex justify-between items-center">
            <!-- Left: Home Button and Logo -->
            <div class="flex items-center space-x-4">
                <a href="https://sings.ai/#" class="flex items-center text-gray-300 hover:text-white transition-colors">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    <span data-key="navHome">返回主页</span>
                </a>
                <a href="https://sings.ai/#" class="text-xl font-bold text-white">sings.ai</a>
            </div>

            <!-- Right: Language Switcher Dropdown -->
            <div class="relative" id="lang-switcher-container">
                <button id="lang-switcher-button" class="lang-button flex items-center space-x-2">
                    <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 008.716-6.747M12 21a9.004 9.004 0 01-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 017.843 4.582M12 3a8.997 8.997 0 00-7.843 4.582m15.686 0A11.953 11.953 0 0112 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0121 12c0 .778-.099 1.533-.284 2.253m0 0A17.919 17.919 0 0112 16.5c-3.162 0-6.133-.815-8.716-2.247m0 0A9.004 9.004 0 013 12c0-1.615.42-3.119 1.157-4.418" />
                    </svg>
                    <span id="current-lang-text" data-key="langCurrent" class="text-sm">简体中文</span>
                    <svg class="w-4 h-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                    </svg>
                </button>
                <div id="lang-dropdown" class="lang-dropdown-menu absolute top-full right-0 mt-2 w-36 rounded-lg shadow-lg hidden z-10">
                    <a href="#" class="block px-4 py-2 text-sm text-gray-300" data-lang="zh" data-key="langZh">简体中文</a>
                    <a href="#" class="block px-4 py-2 text-sm text-gray-300" data-lang="en" data-key="langEn">English</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-4 md:p-8 max-w-4xl px-4 pt-32 md:pt-40 pb-16 md:pb-24">
        <!-- Page Title Header -->
        <header class="text-center my-10">
            <h1 class="text-3xl md:text-5xl font-extrabold text-white">
                <span data-key="mainTitlePart1"></span><span class="gradient-text" data-key="mainTitlePart2"></span><span data-key="mainTitlePart3"></span>
            </h1>
            <p class="mt-3 text-lg text-gray-400" data-key="mainSubtitle">与虚拟用户对话，发掘真实洞察。</p>
        </header>

        <!-- Progress Bar -->
        <div class="mb-8">
            <div class="progress-bar-bg w-full h-2.5 rounded-full">
                <div id="progress-bar" class="progress-bar-fill h-2.5 rounded-full" style="width: 0%;"></div>
            </div>
            <div id="progress-labels" class="flex justify-between text-xs mt-2 text-gray-500">
                <span data-key="progress1">需求输入</span>
                <span data-key="progress2">需求确认</span>
                <span data-key="progress3">访谈大纲</span>
                <span data-key="progress4">招募用户</span>
                <span data-key="progress5">用户访谈</span>
                <span data-key="progress6">洞察分析</span>
                <span data-key="progress7">分析报告</span>
            </div>
        </div>

        <!-- Step 1: Input Research Needs (Optimized) -->
        <div id="step-1" class="step-card active">
            <h2 class="text-2xl font-bold mb-2" data-key="step1Title">第一步：输入研究需求</h2>
            <p class="text-gray-400 mb-6" data-key="step1Desc">请用自然语言简单描述你的研究背景、目的和想要了解的核心问题。</p>
            <textarea id="research-input" class="h-40" data-key-placeholder="step1Placeholder"></textarea>
            
            <div class="mt-6 flex justify-end">
                <button onclick="handleStep1Next()" id="step1-next-btn" class="btn-primary" data-key="nextBtn">下一步</button>
            </div>
        </div>

        <!-- Step 2: Refine Needs & Define Sample -->
        <div id="step-2" class="step-card">
            <h2 class="text-2xl font-bold mb-2" data-key="step2Title">第二步：确认研究需求与样本</h2>
            <p class="text-gray-400 mb-6" data-key="step2Desc">AI已为你提炼出最符合你需求的研究目标，并生成了用户招募条件。请检查并修改。</p>
            <div>
                <label for="refined-need" class="form-label" data-key="step2Label1">研究目标</label>
                <textarea id="refined-need" class="form-input h-28"></textarea>
            </div>
            <hr class="my-6 border-gray-700">
            <h3 class="text-xl font-bold mb-4" data-key="step2Subtitle">建议的样本条件</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label for="criteria-city" class="form-label" data-key="step2LabelCity">城市</label><input type="text" id="criteria-city" class="form-input" data-key-placeholder="step2PlaceholderCity"></div>
                <div><label for="criteria-age" class="form-label" data-key="step2LabelAge">年龄</label><input type="text" id="criteria-age" class="form-input" data-key-placeholder="step2PlaceholderAge"></div>
                <div><label for="criteria-gender" class="form-label" data-key="step2LabelGender">性别</label><input type="text" id="criteria-gender" class="form-input" data-key-placeholder="step2PlaceholderGender"></div>
                <div class="md:col-span-2"><label for="criteria-other" class="form-label" data-key="step2LabelOther">其他关键特征</label><textarea id="criteria-other" class="form-input h-24" data-key-placeholder="step2PlaceholderOther"></textarea></div>
            </div>
            <div class="mt-8 flex justify-between">
                <button onclick="showStep(1)" class="btn-secondary" data-key="backBtn">返回上一步</button>
                <button onclick="handleStep2Next()" class="btn-primary" data-key="step2Btn">确认，生成访谈大纲</button>
            </div>
        </div>

        <!-- Step 3: Generate Interview Outline (Optimized) -->
        <div id="step-3" class="step-card">
            <h2 class="text-2xl font-bold mb-2" data-key="step3Title">第三步：确认访谈大纲</h2>
            <p class="text-gray-400 mb-6" data-key="step3Desc">AI已为你生成一份最专业的访谈大纲。你可以在此基础上修改，后续访谈将严格依据此大纲进行。</p>
            <textarea id="interview-outline" class="h-64"></textarea>
            <div class="mt-8 flex justify-between">
                <button onclick="showStep(2)" class="btn-secondary" data-key="backBtn">返回上一步</button>
                <button onclick="handleStep3Next()" class="btn-primary" data-key="step3Btn">确认大纲，开始招募用户</button>
            </div>
        </div>

        <!-- Step 4: Recruit Participants (with Edit functionality) -->
        <div id="step-4" class="step-card">
            <h2 class="text-2xl font-bold mb-2" data-key="step4Title">第四步：招募虚拟用户</h2>
            <p class="text-gray-400 mb-6" data-key="step4Desc">根据你确认的样本条件，AI已为你招募了符合条件的虚拟用户。你可以编辑或补充，使他们更贴近你的目标用户。</p>
            <div id="participants-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            <div class="flex justify-center mt-6 space-x-4">
                 <button onclick="addParticipantManually()" class="btn-secondary flex items-center space-x-2">
                     <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                         <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                     </svg>
                     <span data-key="addParticipantBtn">添加用户</span>
                 </button>
                 <button onclick="supplementParticipants()" class="btn-secondary flex items-center space-x-2">
                     <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                         <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.922m-2.461 8.167a5.25 5.25 0 01-5.223-5.32c0-1.42.548-2.732 1.458-3.738M12 21a9 9 0 100-18 9 9 0 000 18z" />
                     </svg>
                     <span data-key="supplementParticipantBtn">补充2名用户</span>
                 </button>
            </div>
            <div class="mt-8 flex justify-between">
                <button onclick="showStep(3)" class="btn-secondary" data-key="backBtn">返回上一步</button>
                <button onclick="handleStep4Next()" class="btn-primary" data-key="step4Btn">确认用户，开始访谈</button>
            </div>
        </div>

        <!-- Step 5: Conduct Focus Group (Optimized) -->
        <div id="step-5" class="step-card">
            <h2 class="text-2xl font-bold mb-2" data-key="step5Title">第五步：用户访谈</h2>
            <p class="text-gray-400 mb-6" data-key="step5Desc">访谈已开始。AI 正在模拟一场真实的、动态的群聊。你可以作为主持人进行追问。</p>
            <div id="chat-container-wrapper" class="flex flex-col h-[70vh] md:h-[60vh]">
                <div id="chat-container" class="flex-grow w-full bg-gray-900/50 rounded-lg p-4 overflow-y-auto flex flex-col space-y-4 border border-gray-700"></div>
                <div id="ask-question-container" class="mt-4 flex space-x-2 hidden">
                    <select id="ask-target" class="form-input w-40 flex-shrink-0">
                        <option value="all" data-key="askAll">所有人</option>
                    </select>
                    <input type="text" id="ask-question-input" class="form-input flex-grow" data-key-placeholder="askQuestionPlaceholder" placeholder="作为主持人，你可以向用户提问...">
                    <button id="ask-question-btn" onclick="askQuestion()" class="btn-primary flex-shrink-0">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" />
                        </svg>
                    </button>
                </div>
            </div>
            <div class="mt-6 flex justify-between space-x-4">
                 <button id="end-interview-btn" onclick="endInterview()" class="btn-secondary" data-key="endInterviewBtn">结束访谈</button>
                <button id="skip-to-results-btn" onclick="skipToResults()" class="btn-secondary" data-key="step5SkipBtn">后台处理，抢先看结果</button>
                <button id="step-5-next-btn" onclick="handleStep5Next()" class="btn-primary" disabled data-key="step5NextBtnDisabled">访谈进行中...</button>
            </div>
        </div>

        <!-- Step 6: Generate VOC & Sentiment Analysis -->
        <div id="step-6" class="step-card">
            <h2 class="text-2xl font-bold mb-2" data-key="step6Title">第六步：洞察分析</h2>
            <p class="text-gray-400 mb-6" data-key="step6Desc">访谈结束。AI已从对话中提炼出核心的用户观点和引述，并进行了情感分析。</p>
            <div id="voc-content" class="w-full h-96 bg-gray-900/50 rounded-lg p-4 border border-gray-700 overflow-y-auto voc-content"></div>
            <div id="sentiment-summary" class="mt-4 flex justify-between items-center text-sm">
                <span class="text-gray-400" data-key="sentimentTotal">总情感倾向：</span>
                <div id="sentiment-summary-badges"></div>
            </div>
            <div class="mt-8 flex justify-between">
                <button onclick="showStep(5)" class="btn-secondary" data-key="backBtn">返回上一步</button>
                <button onclick="handleStep6Next()" class="btn-primary" data-key="step6NextBtn">生成最终报告</button>
            </div>
        </div>

        <!-- Step 7: Data Analysis & Report -->
        <div id="step-7" class="step-card">
            <h2 class="text-2xl font-bold mb-2" data-key="step7Title">第七步：数据分析与研究报告</h2>
            <p class="text-gray-400 mb-6" data-key="step7Desc">基于本次研究的全过程，AI已为你生成一份详细的研究报告。</p>
            
            <!-- 新增的情感可视化图表容器 -->
            <div class="mb-8 p-4 rounded-lg bg-gray-900/50 border border-gray-700">
                <h3 class="text-lg font-semibold text-white mb-4" data-key="sentimentChartTitle">访谈情绪分布</h3>
                <div class="h-64">
                    <canvas id="sentimentChart"></canvas>
                </div>
            </div>
            
            <div id="report-content" class="w-full bg-white text-gray-800 rounded-lg p-6 border overflow-y-auto report-content"></div>
            <div class="mt-8 flex justify-between">
                <button onclick="showStep(6)" class="btn-secondary" data-key="backBtn">返回上一步</button>
                <div class="flex items-center space-x-2">
                    <button onclick="downloadReportAsPDF()" class="btn-secondary" data-key="downloadPdfBtn">下载报告 (PDF)</button>
                    <button onclick="restart()" class="btn-primary" data-key="restartBtn">完成，重新开始</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Participant Edit Modal -->
    <div id="edit-participant-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-gray-900 border border-gray-700 text-white p-6 rounded-lg shadow-lg w-full max-w-lg mx-auto">
            <h3 class="text-xl font-bold mb-4" data-key="editParticipantTitle">编辑用户画像</h3>
            <form id="edit-participant-form">
                <div class="mb-4">
                    <label for="edit-name" class="form-label">姓名</label>
                    <input type="text" id="edit-name" name="name" class="form-input" required>
                </div>
                <div class="mb-4">
                    <label for="edit-age" class="form-label">年龄</label>
                    <input type="text" id="edit-age" name="age" class="form-input" required>
                </div>
                <div class="mb-4">
                    <label for="edit-gender" class="form-label">性别</label>
                    <input type="text" id="edit-gender" name="gender" class="form-input" required>
                </div>
                <div class="mb-4">
                    <label for="edit-city" class="form-label">城市</label>
                    <input type="text" id="edit-city" name="city" class="form-input" required>
                </div>
                <div class="mb-4">
                    <label for="edit-profession" class="form-label">职业</label>
                    <input type="text" id="edit-profession" name="profession" class="form-input" required>
                </div>
                <div class="mb-4">
                    <label for="edit-bio" class="form-label">简介</label>
                    <textarea id="edit-bio" name="bio" class="form-input h-24" required></textarea>
                </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" onclick="closeEditModal()" class="btn-secondary" data-key="cancelBtn">取消</button>
                    <button type="submit" class="btn-primary" data-key="saveBtn">保存</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        // --- Language Translations ---
        const translations = {
            zh: {
                // Page Title
                pageTitle: 'AI Talk Engine - sings.ai',
                // Nav
                navHome: '返回主页',
                langCurrent: '简体中文',
                langZh: '简体中文',
                langEn: 'English',
                // Header
                mainTitlePart1: 'AI ',
                mainTitlePart2: 'Talk',
                mainTitlePart3: ' Engine',
                mainSubtitle: '与虚拟用户对话，发掘真实洞察。',
                // Progress
                progress1: '需求输入',
                progress2: '需求确认',
                progress3: '访谈大纲',
                progress4: '招募用户',
                progress5: '用户访谈',
                progress6: '洞察分析',
                progress7: '分析报告',
                // General Buttons
                nextBtn: '下一步',
                backBtn: '返回上一步',
                cancelBtn: '取消',
                saveBtn: '保存',
                // Step 1
                step1Title: '第一步：输入研究需求',
                step1Desc: '请用自然语言简单描述你的研究背景、目的和想要了解的核心问题。',
                step1Placeholder: '例如：我们是一款面向大学生的在线学习App，最近活跃度有所下降。希望了解当前大学生使用在线学习产品的习惯、痛点，以及对我们产品的看法，为产品迭代寻找方向。',
                refinementOptionsTitle: 'AI提炼的专业研究目标 (供选择)',
                selectRefinedBtn: '选择此方案',
                // Step 2
                step2Title: '第二步：确认研究需求与样本',
                step2Desc: 'AI已为你提炼出最符合你需求的研究目标，并生成了用户招募条件。请检查并修改。',
                step2Label1: '研究目标',
                step2Subtitle: '建议的样本条件',
                step2LabelCity: '城市',
                step2PlaceholderCity: '例如：一线、新一线城市',
                step2LabelAge: '年龄',
                step2PlaceholderAge: '例如：18-22岁',
                step2LabelGender: '性别',
                step2PlaceholderGender: '例如：不限',
                step2LabelOther: '其他关键特征',
                step2PlaceholderOther: '例如：每周至少使用3次在线学习App的在校大学生',
                step2Btn: '确认，生成访谈大纲',
                // Step 3
                step3Title: '第三步：确认访谈大纲',
                step3Desc: 'AI已为你生成一份最专业的访谈大纲。你可以在此基础上修改，后续访谈将严格依据此大纲进行。',
                step3Btn: '确认大纲，开始招募用户',
                selectOutlineBtn: '选择此大纲',
                regenerateOutlineBtn: '重新生成大纲',
                // Step 4
                step4Title: '第四步：招募虚拟用户',
                step4Desc: '根据你确认的样本条件，AI已为你招募了符合条件的虚拟用户。你可以编辑或补充，使他们更贴近你的目标用户。',
                step4Btn: '确认用户，开始访谈',
                addParticipantBtn: '添加用户',
                supplementParticipantBtn: '补充2名用户',
                editParticipantTitle: '编辑用户画像',
                // Step 5
                step5Title: '第五步：用户访谈',
                step5Desc: '访谈已开始。AI 正在模拟一场真实的、动态的群聊。你可以作为主持人进行追问。',
                step5SkipBtn: '后台处理，抢先看结果',
                step5NextBtnDisabled: '访谈进行中...',
                step5NextBtnEnabled: '访谈已完成，查看洞察分析',
                askQuestionPlaceholder: '作为主持人，你可以向用户提问...',
                askAll: '所有人',
                endInterviewBtn: '结束访谈',
                // Step 6
                step6Title: '第六步：洞察分析',
                step6Desc: '访谈结束。AI已从对话中提炼出核心的用户观点和引述，并进行了情感分析。',
                step6BackBtn: '查看访谈',
                step6NextBtn: '生成最终报告',
                sentimentTotal: '总情感倾向：',
                sentimentPositive: '积极',
                sentimentNeutral: '中性',
                sentimentNegative: '消极',
                // Step 7
                step7Title: '第七步：数据分析与研究报告',
                step7Desc: '基于本次研究的全过程，AI已为你生成一份详细的研究报告。',
                step7BackBtn: '查看洞察',
                downloadPdfBtn: '下载报告 (PDF)',
                restartBtn: '完成，重新开始',
                sentimentChartTitle: '访谈情绪分布',
                // Dynamic Text
                loaderText: 'AI 正在思考...',
                loaderAnalyzing: '正在分析您的研究需求...',
                loaderCriteria: '正在建议用户样本条件...',
                loaderOutline: '正在生成访谈大纲草稿...',
                loaderRecruiting: '正在招募虚拟用户...',
                loaderSkipping: '正在为您跳过访谈，直接生成结果...',
                loaderVoc: '正在进行洞察分析...',
                loaderReport: '正在撰写最终分析报告...',
                loaderPdf: '正在生成PDF报告...',
                modalInputError: '请输入你的研究需求。',
                modalCriteriaError: 'AI未能生成有效的样本条件，请重试。',
                modalEmptyError: '研究目标和关键特征不能为空。',
                modalOutlineError: '访谈大纲不能为空。',
                modalRecruitError: '招募用户失败，AI返回的数据格式不正确。',
                modalPdfError: '报告内容为空，无法下载。',
                modalPdfGenError: '抱歉，生成PDF报告时出现问题。',
                modalApiError: '调用AI时发生错误: ',
                modalOkBtn: '好的',
                pdfFileName: 'AI-研究报告.pdf'
            },
            en: {
                // Page Title
                pageTitle: 'AI Talk Engine - sings.ai',
                // Nav
                navHome: 'Back to Home',
                langCurrent: 'English',
                langZh: '简体中文',
                langEn: 'English',
                // Header
                mainTitlePart1: 'AI ',
                mainTitlePart2: 'Talk',
                mainTitlePart3: ' Engine',
                mainSubtitle: 'Converse with virtual users, uncover real insights.',
                // Progress
                progress1: 'Input Needs',
                progress2: 'Confirm Needs',
                progress3: 'Interview Outline',
                progress4: 'Recruit Users',
                progress5: 'User Interview',
                progress6: 'Insight Analysis',
                progress7: 'Analysis Report',
                // General Buttons
                nextBtn: 'Next',
                backBtn: 'Back',
                cancelBtn: 'Cancel',
                saveBtn: 'Save',
                // Step 1
                step1Title: 'Step 1: Input Research Needs',
                step1Desc: 'Briefly describe your research background, objectives, and key questions in natural language.',
                step1Placeholder: 'e.g., We are an online learning app for college students, and our recent activity has declined. We want to understand the current habits and pain points of college students using online learning products, as well as their opinions on our product, to find direction for product iteration.',
                refinementOptionsTitle: 'AI-refined Research Objectives (Choose one)',
                selectRefinedBtn: 'Select this option',
                // Step 2
                step2Title: 'Step 2: Confirm Needs & Sample',
                step2Desc: 'AI has refined the most suitable research objective and generated user recruitment criteria for you. Please review and edit them.',
                step2Label1: 'Research Objectives',
                step2Subtitle: 'Suggested Sample Criteria',
                step2LabelCity: 'City',
                step2PlaceholderCity: 'e.g., Tier 1, New Tier 1 cities',
                step2LabelAge: 'Age',
                step2PlaceholderAge: 'e.g., 18-22 years old',
                step2LabelGender: 'Gender',
                step2PlaceholderGender: 'e.g., Any',
                step2LabelOther: 'Other Key Features',
                step2PlaceholderOther: 'e.g., Current college students who use an online learning app at least 3 times a week',
                step2Btn: 'Confirm, Generate Outline',
                // Step 3
                step3Title: 'Step 3: Confirm Interview Outline',
                step3Desc: 'AI has generated the most professional interview outline for you. You can modify it here, and the subsequent interview will strictly follow this outline.',
                step3Btn: 'Confirm Outline, Recruit Users',
                selectOutlineBtn: 'Select this outline',
                regenerateOutlineBtn: 'Regenerate Outlines',
                // Step 4
                step4Title: 'Step 4: Recruit Virtual Users',
                step4Desc: 'Based on your confirmed sample criteria, the AI has recruited virtual users who meet the conditions. You can edit or add more to make them more aligned with your target users.',
                step4Btn: 'Confirm Users, Start Interview',
                addParticipantBtn: 'Add User',
                supplementParticipantBtn: 'Add 2 more users',
                editParticipantTitle: 'Edit Participant Profile',
                // Step 5
                step5Title: 'Step 5: User Interview',
                step5Desc: 'The interview has started. The AI is simulating a real, dynamic group chat. You can ask questions as a moderator.',
                step5SkipBtn: 'Process in Background & See Results',
                step5NextBtnDisabled: 'Interview in progress...',
                step5NextBtnEnabled: 'Interview Complete, View Insights',
                askQuestionPlaceholder: 'As the moderator, you can ask a question...',
                askAll: 'Everyone',
                endInterviewBtn: 'End Interview',
                // Step 6
                step6Title: 'Step 6: Insight Analysis',
                step6Desc: 'Interview finished. The AI has extracted the core user opinions and quotes, and performed sentiment analysis.',
                step6BackBtn: 'View Interview',
                step6NextBtn: 'Generate Final Report',
                sentimentTotal: 'Overall Sentiment:',
                sentimentPositive: 'Positive',
                sentimentNeutral: 'Neutral',
                sentimentNegative: 'Negative',
                // Step 7
                step7Title: 'Step 7: Data Analysis & Research Report',
                step7Desc: 'Based on the entire process of this study, the AI has generated a detailed research report for you.',
                step7BackBtn: 'View Insights',
                downloadPdfBtn: 'Download Report (PDF)',
                restartBtn: 'Finish, Restart',
                sentimentChartTitle: 'Interview Sentiment Distribution',
                // Dynamic Text
                loaderText: 'AI is thinking...',
                loaderAnalyzing: 'Analyzing your research needs...',
                loaderCriteria: 'Suggesting user sample criteria...',
                loaderOutline: 'Generating professional interview outlines...',
                loaderRecruiting: 'Recruiting virtual users...',
                loaderSkipping: 'Skipping interview and generating results for you...',
                loaderVoc: 'Extracting Voice of Customer...',
                loaderReport: 'Writing the final analysis report...',
                loaderPdf: 'Generating PDF report...',
                modalInputError: 'Please enter your research needs.',
                modalCriteriaError: 'AI failed to generate valid sample criteria. Please try again.',
                modalEmptyError: 'Research objectives and key features cannot be empty.',
                modalOutlineError: 'Interview outline cannot be empty.',
                modalRecruitError: 'Failed to recruit users. The data format returned by the AI is incorrect.',
                modalPdfError: 'Report content is empty and cannot be downloaded.',
                modalPdfGenError: 'Sorry, there was a problem generating the PDF report.',
                modalApiError: 'An error occurred while calling the AI: ',
                modalOkBtn: 'OK',
                pdfFileName: 'AI-Research-Report.pdf'
            }
        };

        // --- Global State Management ---
        const appState = {
            currentStep: 1,
            researchNeed: '',
            refinedNeed: '',
            recruitmentCriteria: { city: '', age: '', gender: '', other: '' },
            interviewOutline: '',
            participants: [],
            chatHistory: [],
            voc: '',
            report: '',
            sentimentData: null,
            isInterviewRunning: false,
            currentLanguage: 'zh',
            interviewController: {
                loopTimeout: null,
                participantQueue: [],
                isPausedForUserInput: false,
            }
        };

        let myChart = null;
        const loaderOverlay = document.getElementById('loader-overlay');
        const loaderText = document.getElementById('loader-text');
        let coreQuestions = [];
        let currentQuestionIndex = 0;

        // --- Language Switching ---
        function setLanguage(lang) {
            appState.currentLanguage = lang;
            document.documentElement.lang = lang;
            
            document.querySelectorAll('[data-key]').forEach(el => {
                const key = el.dataset.key;
                if (translations[lang][key]) {
                    el.textContent = translations[lang][key];
                }
            });
            
            document.querySelectorAll('[data-key-placeholder]').forEach(el => {
                const key = el.dataset.keyPlaceholder;
                if (translations[lang][key]) {
                    el.placeholder = translations[lang][key];
                }
            });
            
            const nextBtn = document.getElementById('step-5-next-btn');
            if (nextBtn) {
                nextBtn.textContent = appState.isInterviewRunning ? translations[lang].step5NextBtnDisabled : translations[lang].step5NextBtnEnabled;
            }
            
            document.title = translations[lang].pageTitle;
        }

        // --- UI & Navigation ---
        function showStep(stepNumber) {
            document.querySelectorAll('.step-card').forEach(card => card.classList.remove('active'));
            document.getElementById(`step-${stepNumber}`).classList.add('active');
            appState.currentStep = stepNumber;
            updateProgressBar();

            if (stepNumber === 5) {
                document.getElementById('ask-question-container').classList.remove('hidden');
                document.getElementById('ask-question-container').style.opacity = '0';
                updateAskTargetDropdown();
                setTimeout(() => {
                    document.getElementById('ask-question-container').style.opacity = '1';
                }, 100);
            } else {
                document.getElementById('ask-question-container').classList.add('hidden');
            }
            
            if (stepNumber === 7) {
                renderSentimentChart();
            }
        }

        function updateAskTargetDropdown() {
            const dropdown = document.getElementById('ask-target');
            dropdown.innerHTML = '';
            const allOption = document.createElement('option');
            allOption.value = 'all';
            allOption.textContent = translations[appState.currentLanguage].askAll;
            dropdown.appendChild(allOption);
            appState.participants.forEach(p => {
                const option = document.createElement('option');
                option.value = p.name;
                option.textContent = p.name;
                dropdown.appendChild(option);
            });
        }

        function updateProgressBar() {
            const progress = ((appState.currentStep - 1) / 6) * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;
            const labels = document.getElementById('progress-labels').children;
            for (let i = 0; i < labels.length; i++) {
                labels[i].classList.toggle('text-indigo-400', i < appState.currentStep);
                labels[i].classList.toggle('font-semibold', i < appState.currentStep);
            }
        }

        function showLoader(show, textKey = 'loaderText') {
            loaderText.textContent = translations[appState.currentLanguage][textKey];
            loaderOverlay.style.display = show ? 'flex' : 'none';
        }
        
        function showModal(messageKey, errorDetails = '') {
            let existingModal = document.getElementById('custom-modal');
            if (existingModal) existingModal.remove();

            const message = translations[appState.currentLanguage][messageKey] + errorDetails;

            const modalOverlay = document.createElement('div');
            modalOverlay.id = 'custom-modal';
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4';
            modalOverlay.onclick = () => modalOverlay.remove();
            
            const modalContent = document.createElement('div');
            modalContent.className = 'bg-gray-900 border border-gray-700 text-white p-6 rounded-lg shadow-lg max-w-sm mx-auto text-center';
            modalContent.onclick = (e) => e.stopPropagation();
            
            const messageP = document.createElement('p');
            messageP.textContent = message;
            messageP.className = 'mb-6 text-lg';
            
            const closeButton = document.createElement('button');
            closeButton.textContent = translations[appState.currentLanguage].modalOkBtn;
            closeButton.className = 'btn-primary w-full';
            closeButton.onclick = () => modalOverlay.remove();
            
            modalContent.append(messageP, closeButton);
            modalOverlay.appendChild(modalContent);
            document.body.appendChild(modalOverlay);
        }

        function restart() {
            endInterview(); // Ensure any running interview is stopped
            Object.assign(appState, {
                currentStep: 1, researchNeed: '', refinedNeed: '',
                recruitmentCriteria: { city: '', age: '', gender: '', other: '' },
                interviewOutline: '', participants: [], chatHistory: [], voc: '', report: '', sentimentData: null, isInterviewRunning: false,
                interviewController: { loopTimeout: null, participantQueue: [], isPausedForUserInput: false }
            });
            ['research-input', 'refined-need', 'criteria-city', 'criteria-age', 'criteria-gender', 'criteria-other', 'interview-outline'].forEach(id => document.getElementById(id).value = '');
            ['participants-grid', 'chat-container', 'voc-content', 'report-content', 'sentiment-summary-badges'].forEach(id => document.getElementById(id).innerHTML = '');
            
            const nextBtn = document.getElementById('step-5-next-btn');
            if (nextBtn) {
                nextBtn.disabled = true;
                nextBtn.textContent = translations[appState.currentLanguage].step5NextBtnDisabled;
            }
            
            document.getElementById('skip-to-results-btn').style.display = 'inline-block';
            document.getElementById('end-interview-btn').style.display = 'inline-block';
            if (myChart) myChart.destroy();
            showStep(1);
        }

        // --- Real API Call to SiliconFlow with Retry and Timeout Logic ---
        async function callAIModel(prompt, expectJson = false, useGlobalLoader = true, loaderMsgKey = 'loaderText', maxRetries = 3) {
            if (useGlobalLoader) {
                showLoader(true, loaderMsgKey);
            }
            
            try {
                const apiKey = "sk-xifmrwnarxegowpdpwjmbpiodhjawjtacbkgtkoygpgszhec";
                const url = "https://api.siliconflow.cn/v1/chat/completions";

                const payload = {
                    model: "alibaba/Qwen2-7B-Instruct",
                    messages: [{ role: "user", content: prompt }],
                    temperature: 0.8, 
                    max_tokens: 1024,
                };

                if (expectJson) {
                    payload.response_format = { type: "json_object" };
                }

                let lastError = null;

                for (let attempt = 1; attempt <= maxRetries; attempt++) {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 30000);

                    try {
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${apiKey}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(payload),
                            signal: controller.signal
                        });
                        
                        clearTimeout(timeoutId);

                        if (!response.ok) {
                            const errorBody = await response.text();
                            throw new Error(`API request failed with status ${response.status}: ${errorBody}`);
                        }

                        const data = await response.json();
                        
                        if (!data.choices || data.choices.length === 0) {
                            throw new Error("API returned no choices.");
                        }

                        const content = data.choices[0].message.content;

                        if (expectJson) {
                            const jsonMatch = content.match(/```json\s*([\s\S]*?)\s*```/);
                            let jsonString = jsonMatch ? jsonMatch[1] : content;
                            
                            const firstBracket = jsonString.indexOf('[');
                            const firstBrace = jsonString.indexOf('{');
                            
                            let startIndex = -1;
                            if (firstBracket !== -1 && (firstBracket < firstBrace || firstBrace === -1)) {
                                startIndex = firstBracket;
                            } else {
                                startIndex = firstBrace;
                            }

                            if (startIndex === -1) throw new Error("No JSON object/array found in the response.");
                            
                            jsonString = jsonString.substring(startIndex);
                            jsonString = jsonString.replace(/,\s*(?=[}\]])/g, '');
                            
                            return JSON.parse(jsonString);
                        }
                        
                        return content;

                    } catch (error) {
                        clearTimeout(timeoutId);
                        lastError = error;
                        if (error.name === 'AbortError') {
                            console.warn(`Attempt ${attempt} timed out.`);
                            lastError = new Error("API request timed out.");
                        } else {
                            console.warn(`Attempt ${attempt} failed: ${error.message}`);
                        }
                        if (attempt < maxRetries) {
                            await new Promise(r => setTimeout(r, 1000 * attempt));
                        }
                    }
                }

                console.error("All API call retries failed.", lastError);
                showModal('modalApiError', lastError.message);
                
                if (expectJson) return null;
                return "抱歉，AI服务暂时遇到问题，请稍后再试。";

            } finally {
                if (useGlobalLoader) {
                    showLoader(false);
                }
            }
        }

        // --- Step 1 -> 2 ---
        async function handleStep1Next() {
            appState.researchNeed = document.getElementById('research-input').value;
            if (!appState.researchNeed.trim()) return showModal('modalInputError');
            
            const refinePrompt = `你是一名资深用户研究员。请将以下口语化的研究需求，提炼并改写成一个最清晰、最专业的单一研究目标。只输出改写后的目标，不要任何额外解释。原始需求: "${appState.researchNeed}"`;
            
            const refinedNeedText = await callAIModel(refinePrompt, false, true, 'loaderAnalyzing');
            
            if (refinedNeedText) {
                appState.refinedNeed = refinedNeedText;
                
                const criteriaPrompt = `你是一名用户研究项目经理。根据以下研究目标，提取用于招募用户的核心样本条件。研究目标: "${appState.refinedNeed}"\n请严格按JSON格式输出，包含四个键: "city", "age", "gender", "other"。`;
                const criteria = await callAIModel(criteriaPrompt, true, true, 'loaderCriteria');
                
                if (!criteria) {
                    return;
                }
                
                document.getElementById('refined-need').value = appState.refinedNeed;
                document.getElementById('criteria-city').value = criteria.city || '';
                document.getElementById('criteria-age').value = criteria.age || '';
                document.getElementById('criteria-gender').value = criteria.gender || '';
                document.getElementById('criteria-other').value = criteria.other || '';
                
                showStep(2);
            }
        }

        // --- Step 2 -> 3 ---
        async function handleStep2Next() {
            appState.refinedNeed = document.getElementById('refined-need').value;
            Object.assign(appState.recruitmentCriteria, {
                city: document.getElementById('criteria-city').value,
                age: document.getElementById('criteria-age').value,
                gender: document.getElementById('criteria-gender').value,
                other: document.getElementById('criteria-other').value,
            });
            if (!appState.refinedNeed.trim() || !appState.recruitmentCriteria.other.trim()) return showModal('modalEmptyError');
            
            generateOutline();
        }

        async function generateOutline() {
            const prompt = `你是一位顶尖的市场研究专家。根据以下研究目标和用户样本条件，设计一份最专业的焦点小组访谈大纲。大纲应包含开场热身、背景探查、核心探究、总结收尾等部分，并以Markdown格式编写。\n研究目标: "${appState.refinedNeed}"\n样本条件: 城市:${appState.recruitmentCriteria.city}, 年龄:${appState.recruitmentCriteria.age}, 性别:${appState.recruitmentCriteria.gender}, 其他:${appState.recruitmentCriteria.other}`;
            
            const outline = await callAIModel(prompt, false, true, 'loaderOutline');
            if (outline) {
                appState.interviewOutline = outline;
                document.getElementById('interview-outline').value = outline;
                showStep(3);
            }
        }

        // --- Step 3 -> 4 ---
        async function handleStep3Next() {
            appState.interviewOutline = document.getElementById('interview-outline').value;
            if (!appState.interviewOutline.trim()) return showModal('modalOutlineError');

            const criteriaString = `城市: ${appState.recruitmentCriteria.city}, 年龄: ${appState.recruitmentCriteria.age}, 性别: ${appState.recruitmentCriteria.gender}, 其他特征: ${appState.recruitmentCriteria.other}`;
            const prompt = `根据以下用户样本条件，生成6位符合条件的虚拟用户画像。\n样本条件: ${criteriaString}\n请严格按JSON格式输出一个包含6个用户对象的数组。每个对象必须包含: name, age, gender, city, profession, bio。确保画像多样且符合条件。`;
            
            const participants = await callAIModel(prompt, true, true, 'loaderRecruiting');

            if (participants && Array.isArray(participants)) {
                appState.participants = participants;
                renderParticipants();
                showStep(4);
            } else {
                showModal("modalRecruitError");
            }
        }

        async function supplementParticipants() {
            const criteriaString = `城市: ${appState.recruitmentCriteria.city}, 年龄: ${appState.recruitmentCriteria.age}, 性别: ${appState.recruitmentCriteria.gender}, 其他特征: ${appState.recruitmentCriteria.other}`;
            const prompt = `根据以下用户样本条件，生成2位符合条件的虚拟用户画像。避免与现有用户画像重复。\n现有用户: ${JSON.stringify(appState.participants, null, 2)}\n样本条件: ${criteriaString}\n请严格按JSON格式输出一个包含2个用户对象的数组。每个对象必须包含: name, age, gender, city, profession, bio。`;
            
            const newParticipants = await callAIModel(prompt, true, true, 'loaderRecruiting');

            if (newParticipants && Array.isArray(newParticipants)) {
                appState.participants.push(...newParticipants);
                renderParticipants();
            } else {
                showModal("modalRecruitError");
            }
        }
        
        function renderParticipants() {
            const grid = document.getElementById('participants-grid');
            grid.innerHTML = '';
            appState.participants.forEach((p, index) => {
                const card = document.createElement('div');
                card.className = 'participant-card border border-gray-700 rounded-lg p-4 bg-gray-900/50 flex flex-col justify-between';
                card.style.transitionDelay = `${100 * index}ms`;
                card.innerHTML = `
                    <div>
                        <h3 class="font-bold text-lg text-white">${p.name}</h3>
                        <p class="text-sm text-gray-400">${p.gender}, ${p.age}岁</p>
                        <p class="text-sm text-gray-400">${p.city} - ${p.profession}</p>
                        <p class="text-xs text-gray-500 mt-2 italic">"${p.bio}"</p>
                    </div>
                    <div class="mt-4 flex space-x-2">
                        <button onclick="editParticipant(${index})" class="btn-link text-sm">编辑</button>
                        <button onclick="removeParticipant(${index})" class="btn-link text-sm text-red-400">删除</button>
                    </div>
                `;
                grid.appendChild(card);
                setTimeout(() => {
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, 10);
            });
        }

        // --- Participant Edit/Add Functions ---
        function addParticipantManually() {
            const newParticipant = { name: '', age: '', gender: '', city: '', profession: '', bio: '' };
            appState.participants.push(newParticipant);
            renderParticipants();
            editParticipant(appState.participants.length - 1);
        }

        function editParticipant(index) {
            const participant = appState.participants[index];
            document.getElementById('edit-name').value = participant.name;
            document.getElementById('edit-age').value = participant.age;
            document.getElementById('edit-gender').value = participant.gender;
            document.getElementById('edit-city').value = participant.city;
            document.getElementById('edit-profession').value = participant.profession;
            document.getElementById('edit-bio').value = participant.bio;
            document.getElementById('edit-participant-form').onsubmit = (e) => {
                e.preventDefault();
                saveParticipant(index);
            };
            document.getElementById('edit-participant-modal').classList.remove('hidden');
        }

        function saveParticipant(index) {
            appState.participants[index].name = document.getElementById('edit-name').value;
            appState.participants[index].age = document.getElementById('edit-age').value;
            appState.participants[index].gender = document.getElementById('edit-gender').value;
            appState.participants[index].city = document.getElementById('edit-city').value;
            appState.participants[index].profession = document.getElementById('edit-profession').value;
            appState.participants[index].bio = document.getElementById('edit-bio').value;
            renderParticipants();
            closeEditModal();
        }

        function removeParticipant(index) {
            appState.participants.splice(index, 1);
            renderParticipants();
        }

        function closeEditModal() {
            document.getElementById('edit-participant-modal').classList.add('hidden');
        }

        // --- Step 4 -> 5 ---
        function handleStep4Next() {
            showStep(5);
            runFocusGroup();
        }

        // --- Focus Group Simulation Core Logic ---
        function showTypingIndicator(show) {
            let indicator = document.getElementById('typing-indicator');
            if (show) {
                if (!indicator) {
                    indicator = document.createElement('div');
                    indicator.id = 'typing-indicator';
                    indicator.className = 'typing-indicator-wrapper';
                    indicator.innerHTML = `
                        <div class="user-avatar">AI</div>
                        <div class="chat-bubble chat-bubble-left">
                            <div class="typing-indicator"><span></span><span></span><span></span></div>
                        </div>`;
                    document.getElementById('chat-container').appendChild(indicator);
                    document.getElementById('chat-container').scrollTop = document.getElementById('chat-container').scrollHeight;
                }
            } else {
                if (indicator) {
                    indicator.remove();
                }
            }
        }

        function addChatMessage(name, text, type, sentiment = 'neutral') {
            const chatContainer = document.getElementById('chat-container');
            const message = { name, text, type, sentiment };
            appState.chatHistory.push(message);
            const isModerator = type === 'moderator';
            
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex items-start space-x-2 w-full ${isModerator ? 'justify-end' : 'justify-start'}`;
            
            const contentWrapper = document.createElement('div');
            contentWrapper.className = `flex items-start space-x-3 max-w-[85%] ${isModerator ? 'flex-row-reverse space-x-reverse' : ''}`;

            const avatar = document.createElement('div');
            avatar.className = `${isModerator ? 'moderator-avatar' : 'user-avatar'}`;
            avatar.textContent = name.substring(0, 1);

            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${isModerator ? 'chat-bubble-right' : 'chat-bubble-left'}`;
            const nameEl = document.createElement('div');
            nameEl.className = `chat-name ${isModerator ? 'chat-name-right' : 'chat-name-left'}`;
            nameEl.textContent = name;
            const textEl = document.createElement('div');
            textEl.textContent = text;
            bubble.append(nameEl, textEl);
            
            if (type === 'user' && sentiment) {
                const sentimentBadge = document.createElement('span');
                sentimentBadge.className = `sentiment-badge sentiment-${sentiment}`;
                sentimentBadge.textContent = translations[appState.currentLanguage][`sentiment${sentiment.charAt(0).toUpperCase() + sentiment.slice(1)}`];
                bubble.appendChild(sentimentBadge);
            }

            contentWrapper.append(avatar, bubble);
            messageWrapper.appendChild(contentWrapper);
            chatContainer.appendChild(messageWrapper);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function parseOutlineQuestions(outlineText) {
            const lines = outlineText.split('\n');
            let questions = [];
            lines.forEach(line => {
                if (/^\s*([\d*-])+\.?\s+/.test(line)) {
                    const question = line.replace(/^\s*([\d*-])+\.?\s+/, '').trim();
                    if (question.length > 8 && !question.toLowerCase().includes('分钟') && !question.toLowerCase().includes('简介') && !question.toLowerCase().includes('介绍')) {
                        questions.push(question);
                    }
                }
            });
            return questions;
        }

        async function runFocusGroup() {
            document.getElementById('chat-container').innerHTML = '';
            appState.chatHistory = [];
            appState.isInterviewRunning = true;
            
            document.getElementById('step-5-next-btn').disabled = true;
            document.getElementById('end-interview-btn').style.display = 'inline-block';
            
            coreQuestions = parseOutlineQuestions(appState.interviewOutline);
            if (coreQuestions.length === 0) {
                addChatMessage('系统', '未能从大纲中解析出核心问题，访谈无法继续。', 'moderator');
                endInterview();
                return;
            }
            
            // Phase 1: Warm-up
            await postModeratorMessage(`你是一位用户研究主持人。请用非常口语化、平易近人的语气说一段开场白欢迎大家。严格遵守：1. 不超过30个字。 2. 直接输出你说的这句话，不要带任何前缀。`);
            await new Promise(r => setTimeout(r, 500));
            
            await postModeratorMessage(`你是一位用户研究主持人。现在请用口语化的语气邀请大家做自我介绍。严格遵守：1. 语气自然、友好。 2. 直接输出你说的这句话，不要带任何前缀。`);

            // Use the queue for introductions
            appState.interviewController.participantQueue = [...appState.participants];
            currentQuestionIndex = 0; // Reset question index
            interviewLoop();
        }

        async function interviewLoop() {
            if (!appState.isInterviewRunning || appState.interviewController.isPausedForUserInput) {
                return;
            }

            // Check if queue is empty
            if (appState.interviewController.participantQueue.length === 0) {
                // All participants have answered the current question. Move to the next.
                currentQuestionIndex++;
                if (currentQuestionIndex >= coreQuestions.length) {
                    // End of interview
                    await postModeratorMessage(`你是一位用户研究主持人。所有问题都讨论完了，请用非常口语化的语气发表结束语，感谢大家。严格遵守：1. 不超过25个字。 2. 直接输出你说的这句话，不要带任何前缀。`);
                    finishInterviewUI();
                    return;
                } else {
                    // Pose the next question and repopulate the queue
                    await postModeratorMessage(`你是一位用户研究主持人，请用自然的语气承上启下，过渡到下一个话题。不要提具体的问题。`);
                    await postModeratorMessage(`你是一位用户研究主持人。现在请用非常口语化、平易近人的语气，提出这个问题：“${coreQuestions[currentQuestionIndex]}”`);
                    appState.interviewController.participantQueue = [...appState.participants].sort(() => Math.random() - 0.5); // Shuffle for variety
                }
            }
            
            // Get the next participant from the queue
            const currentParticipant = appState.interviewController.participantQueue.shift();
            
            // Determine if it's an intro or question
            const type = (currentQuestionIndex === 0 && appState.chatHistory.length < (appState.participants.length + 2)) ? 'intro' : 'question';
            
            await postParticipantReply(currentParticipant, type);
            
            // Add a moderator probe mid-discussion for realism
            if (appState.participants.length - appState.interviewController.participantQueue.length === 3 && Math.random() > 0.5) {
                await postModeratorMessage("你是一位用户研究主持人，请对刚才的讨论做个简短的追问或小结。");
            }

            // Continue the loop
            appState.interviewController.loopTimeout = setTimeout(interviewLoop, 500);
        }

        async function postModeratorMessage(prompt) {
            if (!appState.isInterviewRunning) return;
            showTypingIndicator(true);
            const response = await callAIModel(prompt, false, false);
            showTypingIndicator(false);
            if (response) {
                addChatMessage('主持人', response, 'moderator');
            }
            await new Promise(r => setTimeout(r, 500));
        }

        function getRelevantHistory() {
            // Get last 2 user messages for context
            const userHistory = appState.chatHistory.filter(m => m.type === 'user');
            const recentMessages = userHistory.slice(-2);
            if (recentMessages.length === 0) return '';
            
            const context = recentMessages.map(msg => `${msg.name}: ${msg.text}`).join('\n');
            return `最近的几条发言是:\n${context}`;
        }

        async function postParticipantReply(participant, type) {
            let prompt;
            if (type === 'intro') {
                prompt = `你正在深度扮演一个虚拟用户，参与一场座谈会。你的角色信息: ${JSON.stringify(participant, null, 2)}。主持人请你做个简短的自我介绍。严格遵守：1. 语气非常口语化。 2. 不超过25个字。 3. 直接输出你说的这句话，不要带你的名字或任何前缀。请在响应中包含对你发言的情感判断，只返回一个JSON对象，包含两个键: "text", "sentiment" (值为positive/negative/neutral)。`;
            } else { // 'question' type
                const question = coreQuestions[currentQuestionIndex];
                const relevantHistory = getRelevantHistory();
                prompt = `你正在深度扮演一个虚拟用户，参与一场关于“${appState.refinedNeed}”的座谈会。
---
**你的角色信息 (Your Persona):**
${JSON.stringify(participant, null, 2)}
---
**当前讨论的上下文 (Current Context):**
主持人刚刚提出了这个问题: "${question}"
${relevantHistory}
---
**你的任务 (Your Task):**
现在轮到你发言了。请你完全代入你的角色，**直接针对主持人提出的问题**，做出一个高度仿真、像真人聊天一样、符合你身份的回应。你可以参考或反驳他人的观点。
**严格遵守以下规则:**
1.  **极度简短:** 你的发言**绝对不能超过30个字**。
2.  **绝对口语化:** 语气非常接地气，就像在和朋友微信聊天。
3.  **不要带前缀:** 直接输出你扮演角色说的话，**绝对不要**包含你的名字或任何类似 '小李:' 的前缀。
4.  **JSON格式输出:** 只返回一个JSON对象，包含两个键: "text" (你的发言内容), 和 "sentiment" (值为 "positive", "negative", 或 "neutral")。`;
            }

            showTypingIndicator(true);
            const reply = await callAIModel(prompt, true, false);
            showTypingIndicator(false);

            if (reply && reply.text) {
                addChatMessage(participant.name, reply.text, 'user', reply.sentiment);
            } else {
                console.error("AI returned an invalid response for participant reply:", reply);
                addChatMessage(participant.name, "嗯，让我想想...", 'user', 'neutral');
            }
        }

        async function askQuestion() {
            const questionInput = document.getElementById('ask-question-input');
            const askBtn = document.getElementById('ask-question-btn');
            const questionText = questionInput.value.trim();
            if (!questionText || appState.interviewController.isPausedForUserInput) return;

            appState.interviewController.isPausedForUserInput = true;
            clearTimeout(appState.interviewController.loopTimeout);
            questionInput.disabled = true;
            askBtn.disabled = true;
            
            const selectedTarget = document.getElementById('ask-target').value;
            let targetParticipants = (selectedTarget === 'all') 
                ? appState.participants 
                : appState.participants.filter(p => p.name === selectedTarget);
            
            addChatMessage('主持人', questionText, 'moderator');
            questionInput.value = '';
            
            await new Promise(r => setTimeout(r, 1000));
            
            for (const participant of targetParticipants) {
                const prompt = `你正在深度扮演一个虚拟用户...主持人刚刚追问: "${questionText}"...请你完全代入你的角色...做出回应...`;
                await postParticipantReply(participant, 'question');
            }
            
            if (appState.isInterviewRunning) {
                await postModeratorMessage(`好的，感谢补充。我们继续刚才的话题。`);
                appState.interviewController.isPausedForUserInput = false;
                questionInput.disabled = false;
                askBtn.disabled = false;
                interviewLoop();
            }
        }

        function endInterview() {
            appState.isInterviewRunning = false;
            clearTimeout(appState.interviewController.loopTimeout);
            if (appState.chatHistory.length > 0 && !appState.chatHistory[appState.chatHistory.length-1].text.includes('结束')) {
                 addChatMessage('主持人', '好的，访谈提前结束了，谢谢大家今天的分享！', 'moderator');
            }
            finishInterviewUI();
        }

        function finishInterviewUI() {
            appState.isInterviewRunning = false;
            clearTimeout(appState.interviewController.loopTimeout);

            const nextBtn = document.getElementById('step-5-next-btn');
            const skipBtn = document.getElementById('skip-to-results-btn');
            const endBtn = document.getElementById('end-interview-btn');
            
            nextBtn.disabled = false;
            nextBtn.textContent = translations[appState.currentLanguage].step5NextBtnEnabled;
            skipBtn.style.display = 'none';
            endBtn.style.display = 'none';
            
            document.getElementById('ask-question-input').disabled = true;
            document.getElementById('ask-target').disabled = true;
            document.getElementById('ask-question-btn').disabled = true;
        }

        async function skipToResults() {
            if (appState.isInterviewRunning) {
                endInterview();
                showLoader(true, 'loaderSkipping');
                await new Promise(r => setTimeout(r, 1500));
                handleStep5Next();
            }
        }

        function formatChatHistory() {
            return appState.chatHistory.map(msg => `${msg.name}: ${msg.text}`).join('\n');
        }

        // --- Step 5 -> 6 (Insight Analysis with Sentiment) ---
        async function handleStep5Next() {
            const prompt = `你是一名用户研究员，请分析以下座谈会访谈记录。\n研究目标: "${appState.refinedNeed}"\n访谈记录:\n${formatChatHistory()}\n请为我生成一份JSON对象，包含两个键: "voc" 和 "sentiment"。 "voc" 的值应为一份用Markdown格式编写的“用户之声”(VOC)报告... "sentiment" 的值应为另一个JSON对象...`;
            const result = await callAIModel(prompt, true, true, 'loaderVoc');
            if (result && result.voc && result.sentiment) {
                appState.voc = result.voc;
                appState.sentimentData = result.sentiment;
                document.getElementById('voc-content').innerHTML = marked.parse(result.voc);
                renderSentimentBadges(result.sentiment.overall);
                showStep(6);
            }
        }

        function renderSentimentBadges(sentiment) {
            const container = document.getElementById('sentiment-summary-badges');
            container.innerHTML = '';
            
            const positiveBadge = document.createElement('span');
            positiveBadge.className = 'sentiment-badge sentiment-positive mr-2';
            positiveBadge.textContent = `${translations[appState.currentLanguage].sentimentPositive}: ${sentiment.positive}%`;
            container.appendChild(positiveBadge);

            const neutralBadge = document.createElement('span');
            neutralBadge.className = 'sentiment-badge sentiment-neutral mr-2';
            neutralBadge.textContent = `${translations[appState.currentLanguage].sentimentNeutral}: ${sentiment.neutral}%`;
            container.appendChild(neutralBadge);

            const negativeBadge = document.createElement('span');
            negativeBadge.className = 'sentiment-badge sentiment-negative';
            negativeBadge.textContent = `${translations[appState.currentLanguage].sentimentNegative}: ${sentiment.negative}%`;
            container.appendChild(negativeBadge);
        }

        // --- Step 6 -> 7 ---
        async function handleStep6Next() {
            const prompt = `你是一位顶尖的策略分析师和用户研究专家。请根据以下所有信息，撰写一份完整、深刻、专业的最终研究报告...`;
            const reportResult = await callAIModel(prompt, false, true, 'loaderReport');
            if (reportResult) {
                appState.report = reportResult;
                document.getElementById('report-content').innerHTML = marked.parse(reportResult);
                showStep(7);
            }
        }

        function renderSentimentChart() {
            if (myChart) myChart.destroy();
            const ctx = document.getElementById('sentimentChart').getContext('2d');
            const data = appState.sentimentData;
            if (!data || !data.timeline) return;

            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.timeline.map((_, i) => `讨论主题 ${i + 1}`),
                    datasets: [{
                        label: translations[appState.currentLanguage].sentimentPositive,
                        data: data.timeline.map(d => d.positive),
                        backgroundColor: '#10B981',
                        stack: 'stack'
                    }, {
                        label: translations[appState.currentLanguage].sentimentNeutral,
                        data: data.timeline.map(d => d.neutral),
                        backgroundColor: '#9CA3AF',
                        stack: 'stack'
                    }, {
                        label: translations[appState.currentLanguage].sentimentNegative,
                        data: data.timeline.map(d => d.negative),
                        backgroundColor: '#EF4444',
                        stack: 'stack'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#d1d5db' } },
                        y: { stacked: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#d1d5db' } }
                    },
                    plugins: {
                        legend: { position: 'bottom', labels: { color: '#d1d5db', font: { size: 14, family: 'Inter, sans-serif' } } },
                        title: { display: false }
                    }
                }
            });
        }
        
        // --- PDF Download Function ---
        async function downloadReportAsPDF() {
            const reportContentElement = document.getElementById('report-content');
            if (!reportContentElement || !reportContentElement.innerHTML.trim()) {
                return showModal('modalPdfError');
            }
            showLoader(true, 'loaderPdf');
            try {
                const { jsPDF } = window.jspdf;
                const originalBg = reportContentElement.style.backgroundColor;
                reportContentElement.style.backgroundColor = '#ffffff';
                const canvas = await html2canvas(reportContentElement, { scale: 2, useCORS: true, logging: false, backgroundColor: '#ffffff' });
                reportContentElement.style.backgroundColor = originalBg;

                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const canvasWidth = canvas.width;
                const canvasHeight = canvas.height;
                const ratio = canvasWidth / pdfWidth;
                const imgHeight = canvasHeight / ratio;
                let heightLeft = imgHeight;
                let position = 0;
                pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight, undefined, 'FAST');
                heightLeft -= pdfHeight;
                while (heightLeft > 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight, undefined, 'FAST');
                    heightLeft -= pdfHeight;
                }
                pdf.save(translations[appState.currentLanguage].pdfFileName);
            } catch (error) {
                console.error("Error generating PDF:", error);
                showModal("modalPdfGenError");
            } finally {
                showLoader(false);
            }
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            const langSwitcherButton = document.getElementById('lang-switcher-button');
            const langDropdown = document.getElementById('lang-dropdown');

            langSwitcherButton.addEventListener('click', (event) => {
                event.stopPropagation();
                langDropdown.classList.toggle('hidden');
            });

            document.addEventListener('click', (event) => {
                if (!langSwitcherButton.contains(event.target)) {
                    langDropdown.classList.add('hidden');
                }
            });

            langDropdown.addEventListener('click', (event) => {
                const target = event.target.closest('a');
                if (target && target.dataset.lang) {
                    event.preventDefault();
                    setLanguage(target.dataset.lang);
                    langDropdown.classList.add('hidden');
                }
            });

            setLanguage(appState.currentLanguage);
            showStep(1);
        });
    </script>
</body>
</html>
